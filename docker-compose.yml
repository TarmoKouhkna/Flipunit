version: '3.8'

services:
  web:
    build: .
    container_name: flipunit-web
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=${DEBUG:-False}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-flipunit.eu,www.flipunit.eu,217.146.78.140}
      - CSRF_TRUSTED_ORIGINS=${CSRF_TRUSTED_ORIGINS:-https://flipunit.eu,https://www.flipunit.eu}
      - SITE_URL=${SITE_URL:-https://flipunit.eu}
      - DB_NAME=${DB_NAME:-flipunit}
      - DB_USER=${DB_USER:-flipunit_user}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=postgres
      - DB_PORT=5432
      - GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY}
    volumes:
      - ./media:/app/media
      - ./staticfiles:/app/staticfiles
      - ./static:/app/static  # Mount static source files so changes are immediate without rebuild
      - ./templates:/app/templates  # Mount templates so changes are immediate without rebuild
      - ./flipunit:/app/flipunit  # Mount source code so Python changes are immediate without rebuild
    depends_on:
      - postgres
    networks:
      - flipunit-network

  postgres:
    image: postgres:15
    container_name: flipunit-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${DB_NAME:-flipunit}
      - POSTGRES_USER=${DB_USER:-flipunit_user}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - flipunit-network

volumes:
  postgres-data:

networks:
  flipunit-network:

