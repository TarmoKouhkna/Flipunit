{% extends 'base.html' %}

{% block title %}Audio Converter - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}Free online audio converter - Convert between MP3, WAV, OGG, FLAC, and AAC formats. Fast, simple, no registration required.{% endblock %}
{% block og_title %}Audio Converter - {{ SITE_NAME }}{% endblock %}
{% block og_description %}Free online audio converter - Convert between different audio formats.{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Audio Converter</h1>
    <p>Convert between different audio formats</p>
    
    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    <form method="post" enctype="multipart/form-data" class="converter-tool">
        {% csrf_token %}
        <div class="form-group">
            <label class="form-label" for="audio_file">Select Audio File</label>
            <div class="file-upload-area">
                <input type="file" name="audio_file" id="audio_file" accept="audio/*" required>
                <div style="text-align: center; padding: 2rem;">
                    <p style="font-size: 1.1rem; margin-bottom: 1rem;">Click to select or drag and drop</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Supports: MP3, WAV, OGG, FLAC, AAC, M4A</p>
                </div>
            </div>
        </div>
        
        <div class="form-group" style="margin-top: 1.5rem;">
            <label class="form-label" for="output_format">Output Format</label>
            <select class="form-select" id="output_format" name="output_format" required>
                <option value="mp3">MP3</option>
                <option value="wav">WAV</option>
                <option value="ogg">OGG</option>
                <option value="flac">FLAC</option>
                <option value="aac">AAC</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block">Convert & Download</button>
    </form>
    
    <div style="margin-top: 2rem; padding: 1rem; background: var(--surface); border-radius: 6px;">
        <h3>How to use:</h3>
        <ol style="margin-left: 1.5rem; margin-top: 0.5rem;">
            <li>Upload an audio file (MP3, WAV, OGG, FLAC, or AAC)</li>
            <li>Select the desired output format</li>
            <li>Click "Convert & Download"</li>
            <li>Download the converted audio file</li>
        </ol>
        <p style="margin-top: 1rem; color: var(--text-secondary);">
            <strong>Note:</strong> Lossy formats (MP3, OGG, AAC) are converted at 192 kbps quality. Lossless formats (WAV, FLAC) preserve original quality.
        </p>
    </div>
</div>

<a href="{% url 'media_converter:index' %}" class="btn btn-secondary">‚Üê Back to Media Converters</a>

{% block extra_js %}
<script>
// === SINGLE EXECUTION GUARD ===
if (window.audioConverterInitialized) {
    console.log('Audio converter script already initialized');
} else {
    window.audioConverterInitialized = true;

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('.converter-tool');
        if (!form) return;

        let isProcessing = false;
        let downloadTriggered = false;
        let abortController = null; // Track AbortController for canceling duplicates

        const submitHandler = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();

            // === INSTANT DOUBLE-CLICK PROTECTION ===
            if (isProcessing) {
                console.log('Submit blocked: already processing');
                return false;
            }

            const fileInput = form.querySelector('#audio_file');
            if (!fileInput?.files?.length) {
                alert('Please select an audio file');
                return false;
            }

            // === LOCK IMMEDIATELY ===
            isProcessing = true;
            downloadTriggered = false;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            form.style.pointerEvents = 'none';

            // Abort any previous fetch to kill duplicates
            if (abortController) {
                abortController.abort();
                console.log('Previous fetch aborted');
            }
            abortController = new AbortController(); // Fresh controller

            // Cleanup any old blob URLs
            document.querySelectorAll('a[data-temp-download]').forEach(a => {
                if (a.href.startsWith('blob:')) {
                    URL.revokeObjectURL(a.href);
                }
                a.remove();
            });

            const formData = new FormData(form);

            try {
                const response = await fetch(form.action || window.location.href, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                    signal: abortController.signal // Allows abort
                });

                if (!response.ok) {
                    throw new Error('Conversion failed');
                }

                let blob, filename, contentType = 'audio/mpeg';

                const contentTypeHeader = response.headers.get('content-type');
                if (contentTypeHeader?.includes('application/json')) {
                    // JSON format - extract file data
                    const data = await response.json();
                    const binary = atob(data.file);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }
                    blob = new Blob([bytes], { type: data.content_type || 'audio/mpeg' });
                    filename = data.filename;
                    contentType = data.content_type || 'audio/mpeg';
                } else {
                    // Legacy format - direct audio file
                    blob = await response.blob();
                    filename = response.headers.get('x-filename') || 'converted.audio';
                    contentType = response.headers.get('x-content-type') || contentTypeHeader || 'audio/mpeg';
                    blob = new Blob([blob], { type: contentType });
                }

                // === FINAL DUPLICATE DOWNLOAD GUARD ===
                if (downloadTriggered) {
                    console.log('Download already triggered, skipping');
                    return;
                }
                downloadTriggered = true;

                // Add timestamp to filename to prevent browser de-duping
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const fileExt = filename.match(/\.[^/.]+$/) || '.mp3';
                const baseName = filename.replace(/\.[^/.]+$/, '');
                const uniqueFilename = `${baseName}-${timestamp}${fileExt}`;

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = uniqueFilename; // Use unique name
                a.dataset.tempDownload = 'true';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();

                // Cleanup
                setTimeout(() => {
                    if (document.body.contains(a)) {
                        document.body.removeChild(a);
                    }
                    URL.revokeObjectURL(url);
                }, 100);

            } catch (err) {
                // Ignore abort errors (expected for duplicates)
                if (err.name === 'AbortError') {
                    console.log('Fetch aborted (duplicate prevented)');
                    return;
                }
                console.error('Conversion error:', err);
                alert('Conversion failed. Please try again.');
                window.location.reload();
            } finally {
                // === ALWAYS RESET ===
                isProcessing = false;
                abortController = null; // Clear controller
                submitBtn.disabled = false;
                submitBtn.textContent = 'Convert & Download';
                form.style.pointerEvents = 'auto';
            }
        };

        // Remove ALL existing listeners by cloning (once!)
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        // Get button and add click protection
        const submitBtn = newForm.querySelector('button[type="submit"]');
        
        // Prevent button double-clicks by disabling immediately on click
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                if (isProcessing) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    e.stopPropagation();
                    return false;
                }
            }, { capture: true });
        }

        // Attach single listener to form - use capture phase to catch early
        newForm.addEventListener('submit', submitHandler, { capture: true });
        
        // Also prevent default form submission
        newForm.onsubmit = function(e) {
            e.preventDefault();
            return false;
        };
        
        // Update file name display
        const newFileInput = newForm.querySelector('#audio_file');
        const uploadArea = newForm.querySelector('.file-upload-area');
        if (newFileInput && uploadArea) {
            newFileInput.addEventListener('change', (e) => {
                const fileName = e.target.files[0]?.name;
                const p = uploadArea.querySelector('p');
                if (p && fileName) {
                    p.textContent = 'Selected: ' + fileName;
                }
            });
        }
    });
}
</script>
{% endblock extra_js %}
