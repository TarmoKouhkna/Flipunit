{% extends 'base.html' %}

{% block title %}Rotate & Flip Image - {{ SITE_NAME }}{% endblock %}

{% block extra_css %}
<style>
/* Force consistent text rendering for arrow icons on mobile */
.action-icon {
    font-family: 'Varela Round', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-variant-emoji: text;
    -webkit-font-feature-settings: "liga" off;
    font-feature-settings: "liga" off;
    text-rendering: optimizeLegibility;
    display: inline-block;
    unicode-bidi: bidi-override;
    direction: ltr;
}

/* Create vertical double arrow using CSS to match horizontal arrow style */
.action-icon.flip-vertical {
    position: relative;
    display: inline-block;
    width: 1em;
    height: 1em;
    vertical-align: middle;
    font-size: 1em;
}

.action-icon.flip-vertical::before {
    content: '‚Üî';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(90deg);
    font-family: 'Varela Round', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-variant-emoji: text;
    -webkit-font-feature-settings: "liga" off;
    font-feature-settings: "liga" off;
    display: block;
    line-height: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Rotate & Flip Image</h1>
    <p>Rotate or flip your images</p>
    
    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    <div class="privacy-notice">
        <p>
            <span>üîí</span>
            <span><strong>Privacy Notice:</strong> Your files are processed securely and are <strong>not stored</strong> on our servers.</span>
        </p>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="rotateFlipForm">
        {% csrf_token %}
        <div class="form-group">
            <label class="form-label">Select Image File</label>
            <div class="file-upload-area" id="uploadArea">
                <input type="file" name="image" id="image" accept="image/*,.heic,.heif,image/heic,image/heif" required>
                <div id="uploadContent">
                    <p style="margin-top: 1rem; font-size: 1.1rem;">üìÅ Click to select or drag and drop</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Supports: JPG, JPEG, PNG, WebP, SVG, BMP, TIFF, GIF, ICO, AVIF, HEIC</p>
                </div>
                <div id="imagePreview" style="display: none; margin-top: 1.5rem;">
                    <img id="previewImg" src="" alt="Preview" style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: var(--shadow-lg);">
                    <div id="imageInfo" style="margin-top: 1rem; padding: 1rem; background: var(--surface); border-radius: 6px;">
                        <p style="margin: 0.25rem 0; font-size: 0.9rem;"><strong>File:</strong> <span id="fileName"></span></p>
                        <p style="margin: 0.25rem 0; font-size: 0.9rem;"><strong>Size:</strong> <span id="fileSize"></span></p>
                        <p style="margin: 0.25rem 0; font-size: 0.9rem;"><strong>Dimensions:</strong> <span id="imageDimensions"></span></p>
                        <p style="margin: 0.25rem 0; font-size: 0.9rem;"><strong>Format:</strong> <span id="imageFormat"></span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-group" style="margin-top: 1.5rem;">
            <label class="form-label">Action</label>
            <div class="grid grid-2 gap-md">
                <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="action" value="rotate_90" required>
                    <span><span class="action-icon">‚Üª</span> Rotate 90¬∞ Clockwise</span>
                </label>
                <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="action" value="rotate_180" required>
                    <span><span class="action-icon">‚Üª</span> Rotate 180¬∞</span>
                </label>
                <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="action" value="rotate_270" required>
                    <span><span class="action-icon">‚Ü∫</span> Rotate 90¬∞ Counter-clockwise</span>
                </label>
                <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="action" value="flip_horizontal" required>
                    <span><span class="action-icon">‚Üî</span> Flip Horizontal</span>
                </label>
                <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="action" value="flip_vertical" required>
                    <span><span class="action-icon flip-vertical"></span> Flip Vertical</span>
                </label>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block" id="submitBtn" style="margin-top: 1.5rem;">Apply & Download</button>
    </form>
</div>

<a href="{% url 'image_converter:index' %}" class="btn btn-secondary">‚Üê Back to Image Conversion & Editing</a>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('image');
    const uploadArea = document.getElementById('uploadArea');
    const uploadContent = document.getElementById('uploadContent');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const imageDimensions = document.getElementById('imageDimensions');
    const imageFormat = document.getElementById('imageFormat');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('rotateFlipForm');
    const actionRadios = document.querySelectorAll('input[name="action"]');
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Get file extension
    function getFileExtension(filename) {
        return filename.split('.').pop().toUpperCase();
    }
    
    // Apply transform to preview image
    function applyPreviewTransform(action) {
        if (!previewImg.src) return; // No image loaded yet
        
        // Reset transform first
        previewImg.style.transform = '';
        
        // Apply transform based on action
        switch(action) {
            case 'rotate_90':
                previewImg.style.transform = 'rotate(90deg)';
                break;
            case 'rotate_180':
                previewImg.style.transform = 'rotate(180deg)';
                break;
            case 'rotate_270':
                previewImg.style.transform = 'rotate(-90deg)';
                break;
            case 'flip_horizontal':
                previewImg.style.transform = 'scaleX(-1)';
                break;
            case 'flip_vertical':
                previewImg.style.transform = 'scaleY(-1)';
                break;
            default:
                previewImg.style.transform = '';
        }
    }
    
    // Handle file selection
    function handleFileSelect(file) {
        if (!file) return;
        
        // Reset transform when new file is selected
        previewImg.style.transform = '';
        
        // Update file name
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        imageFormat.textContent = getFileExtension(file.name);
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            
            // Get image dimensions
            const img = new Image();
            img.onload = function() {
                imageDimensions.textContent = img.width + ' √ó ' + img.height + ' pixels';
                imagePreview.style.display = 'block';
                uploadContent.style.display = 'none';
                
                // Apply transform if an action is already selected
                const selectedAction = document.querySelector('input[name="action"]:checked');
                if (selectedAction) {
                    applyPreviewTransform(selectedAction.value);
                }
            };
            img.onerror = function() {
                // If image fails to load, still show file info
                imageDimensions.textContent = 'Unable to load preview';
                imagePreview.style.display = 'block';
                uploadContent.style.display = 'none';
            };
            img.src = e.target.result;
        };
        reader.onerror = function() {
            // If file read fails, still show file info
            imageDimensions.textContent = 'File selected - preview unavailable';
            imagePreview.style.display = 'block';
            uploadContent.style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary-color)';
        uploadArea.style.backgroundColor = 'var(--surface)';
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--border-color)';
        uploadArea.style.backgroundColor = 'transparent';
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--border-color)';
        uploadArea.style.backgroundColor = 'transparent';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    // Add event listeners to radio buttons for live preview
    actionRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
            if (this.checked && previewImg.src) {
                applyPreviewTransform(this.value);
            }
        });
    });
    
    // Store original button text
    const originalButtonText = submitBtn.textContent;
    
    // Form submit handler for loading state
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Check if form is valid
        if (!fileInput.files.length) {
            alert('Please select an image file first.');
            return false;
        }
        
        const selectedAction = document.querySelector('input[name="action"]:checked');
        if (!selectedAction) {
            alert('Please select an action (rotate or flip).');
            return false;
        }
        
        // Prevent double submission
        if (submitBtn.dataset.processing === 'true') {
            return false;
        }
        submitBtn.dataset.processing = 'true';
        
        // Disable button and show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
        
        try {
            // Create FormData
            const formData = new FormData(form);
            
            // Submit via fetch - use current URL explicitly
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });
            
            // Check if response is an image file
            const contentType = response.headers.get('content-type') || '';
            if (contentType.startsWith('image/')) {
                // Get the blob
                const blob = await response.blob();
                
                // Extract filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('content-disposition') || '';
                let filename = 'edited.png';
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                
                // Trigger download
                a.click();
                
                // Clean up
                setTimeout(() => {
                    if (document.body.contains(a)) {
                        document.body.removeChild(a);
                    }
                    URL.revokeObjectURL(url);
                }, 100);
            } else {
                // If response is HTML (error page), reload to show error
                const html = await response.text();
                document.open();
                document.write(html);
                document.close();
                return;
            }
        } catch (error) {
            console.error('Error processing image:', error);
            alert('An error occurred while processing the image. Please try again.');
        } finally {
            // Reset button state immediately after download is triggered
            submitBtn.disabled = false;
            submitBtn.textContent = originalButtonText;
            submitBtn.dataset.processing = 'false';
        }
    });
});
</script>
{% endblock %}

