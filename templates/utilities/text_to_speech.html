{% extends 'base.html' %}

{% block title %}Text-to-Speech - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}Convert text to speech audio. Generate MP3 audio files from text using text-to-speech technology.{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Text-to-Speech</h1>
    <p style="color: var(--text-secondary); margin-bottom: 2rem;">Convert text to speech audio</p>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    {% if not gtts_available and not messages %}
    <div class="alert alert-info">
        <strong>Note:</strong> Text-to-speech requires gTTS library. Install with: pip install gtts
    </div>
    {% endif %}
    
    <form method="post" class="converter-tool">
        {% csrf_token %}
        <div class="form-group">
            <label class="form-label">Text to Convert</label>
            <textarea name="text" id="text" rows="8" class="form-control" placeholder="Enter text to convert to speech..." required maxlength="5000"></textarea>
            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">
                Maximum 5000 characters
            </small>
        </div>
        
        <div class="form-group">
            <label class="form-label">Language</label>
            <select name="language" id="language" class="form-control">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="it">Italian</option>
                <option value="pt">Portuguese</option>
                <option value="ru">Russian</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="zh">Chinese</option>
                <option value="ar">Arabic</option>
                <option value="hi">Hindi</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block" id="submit-btn">Generate Speech</button>
    </form>
    
    <div style="margin-top: 2rem; padding: 1rem; background: var(--surface); border-radius: 6px;">
        <h3>How to use:</h3>
        <ol class="list-indent" style="margin-top: 0.5rem;">
            <li>Enter or paste the text you want to convert</li>
            <li>Select the language</li>
            <li>Click "Generate Speech"</li>
            <li>Download the MP3 audio file</li>
        </ol>
        <p style="margin-top: 1rem; color: var(--text-secondary);">
            <strong>Note:</strong> Text-to-speech requires an internet connection to generate audio.
        </p>
    </div>
</div>

<a href="{% url 'utilities:index' %}" class="btn btn-secondary">‚Üê Back to Utilities</a>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.converter-tool');
    const submitBtn = document.getElementById('submit-btn');
    const textarea = document.getElementById('text');
    
    // Character counter
    textarea.addEventListener('input', function() {
        const charCount = this.value.length;
        const maxChars = 5000;
        const counter = document.querySelector('small');
        counter.textContent = `${charCount} / ${maxChars} characters`;
        
        if (charCount > maxChars) {
            counter.style.color = 'var(--error-color, #dc3545)';
        } else {
            counter.style.color = 'var(--text-secondary)';
        }
    });
    
    const originalText = submitBtn.textContent;
    let isSubmitting = false;
    let downloadTriggered = false;
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Prevent duplicate submissions
        if (isSubmitting) {
            console.log('Submission already in progress, ignoring duplicate submit');
            return false;
        }
        
        isSubmitting = true;
        downloadTriggered = false;
        
        // Update button state
        submitBtn.textContent = 'Generating...';
        submitBtn.disabled = true;
        
        // Store original text
        if (!submitBtn.dataset.originalText) {
            submitBtn.dataset.originalText = originalText;
        }
        
        // Create FormData
        const formData = new FormData(form);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            alert('CSRF token not found. Please refresh the page.');
            isSubmitting = false;
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return false;
        }
        
        // Function to reset button
        const resetButton = () => {
            const resetText = submitBtn.dataset.originalText || originalText || 'Generate Speech';
            submitBtn.textContent = resetText;
            submitBtn.disabled = false;
            isSubmitting = false;
            console.log('Button reset to:', resetText);
        };
        
        // Submit form using fetch
        const submitUrl = form.action || window.location.pathname;
        console.log('Submitting to:', submitUrl);
        
        fetch(submitUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken.value
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            
            if (response.ok && response.headers.get('content-type')?.includes('audio')) {
                return response.blob();
            }
            
            // If not OK, try to get error message
            return response.text().then(text => {
                console.error('Error response:', text);
                throw new Error(text || 'Generation failed');
            });
        })
        .then(blob => {
            console.log('Received blob, size:', blob.size);
            
            // Prevent duplicate downloads
            if (downloadTriggered) {
                console.warn('Download already triggered, skipping duplicate');
                resetButton();
                return;
            }
            
            downloadTriggered = true;
            console.log('Triggering download...');
            
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'speech.mp3';
            a.style.display = 'none';
            a.id = 'speech-download-link-' + Date.now();
            
            // Remove any existing download links
            const existingLinks = document.querySelectorAll('a[id^="speech-download-link-"]');
            existingLinks.forEach(link => {
                if (document.body.contains(link)) {
                    document.body.removeChild(link);
                }
            });
            
            document.body.appendChild(a);
            
            // Trigger download
            setTimeout(() => {
                if (!document.body.contains(a)) {
                    console.warn('Download link removed before click');
                    resetButton();
                    return;
                }
                
                a.click();
                console.log('Download triggered');
                
                // Wait for download to complete before resetting button
                // Use a longer delay to ensure download has started
                setTimeout(() => {
                    if (document.body.contains(a)) {
                        document.body.removeChild(a);
                    }
                    window.URL.revokeObjectURL(url);
                    
                    // Reset button after download has been triggered
                    resetButton();
                }, 500); // Increased delay to ensure download starts
            }, 10);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating speech: ' + (error.message || 'Please try again.'));
            resetButton();
        })
        .finally(() => {
            // Safety net: ensure button resets even if something goes wrong
            setTimeout(() => {
                if (submitBtn.textContent === 'Generating...' && submitBtn.disabled) {
                    console.warn('Button still in generating state, forcing reset');
                    resetButton();
                }
            }, 10000); // After 10 seconds, force reset if still generating
        });
        
        return false;
    });
});
</script>
{% endblock %}
{% endblock %}

