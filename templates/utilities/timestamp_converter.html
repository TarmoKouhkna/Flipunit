{% extends 'base.html' %}

{% block title %}Timestamp Converter - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}Convert between Unix timestamps and dates. Convert timestamps to readable dates and dates to timestamps.{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Timestamp ↔ Date Converter</h1>
    <p style="color: var(--text-secondary); margin-bottom: 2rem;">Convert between Unix timestamps and human-readable dates</p>
    
    {% if error %}
        <div class="alert alert-error">
            {{ error }}
        </div>
    {% endif %}
    
    {% if result %}
        <div class="alert alert-success" style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 0.5rem;">Result:</h3>
            {% if result.type == 'date' %}
                <p><strong>UTC:</strong> {{ result.utc }}</p>
                <p><strong>Local:</strong> <span id="local-time">{{ result.utc }}</span> <span id="local-timezone"></span></p>
                <p><strong>ISO:</strong> {{ result.iso }}</p>
            {% else %}
                <p><strong>Seconds:</strong> {{ result.seconds }}</p>
                <p><strong>Milliseconds:</strong> {{ result.milliseconds }}</p>
            {% endif %}
        </div>
    {% endif %}
    
    <form method="post" class="converter-tool">
        {% csrf_token %}
        <div class="form-group">
            <label class="form-label">Conversion Type</label>
            <select name="conversion_type" id="conversion_type" class="form-control">
                <option value="timestamp_to_date" {% if conversion_type == 'timestamp_to_date' or not conversion_type %}selected{% endif %}>Timestamp → Date</option>
                <option value="date_to_timestamp" {% if conversion_type == 'date_to_timestamp' %}selected{% endif %}>Date → Timestamp</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="input_label">Enter Timestamp</label>
            <input type="text" name="input_value" id="input_value" class="form-control" placeholder="1699123456">
            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;" id="input_hint">
                Enter Unix timestamp (seconds or milliseconds)
            </small>
        </div>
        
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">Convert</button>
            <button type="button" id="get-current-timestamp" class="btn btn-secondary" style="display: none;" data-get-current="timestamp">Get Current Timestamp</button>
            <button type="button" id="get-current-date" class="btn btn-secondary" style="display: none;" data-get-current="date">Get Current Date & Time</button>
        </div>
    </form>
    
    <div style="margin-top: 2rem; padding: 1rem; background: var(--surface); border-radius: 6px;">
        <h3>How to use:</h3>
        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
            <li><strong>Timestamp → Date:</strong> Enter Unix timestamp (seconds or milliseconds) to get human-readable date, or click "Get Current Date & Time" to see the current server time</li>
            <li><strong>Date → Timestamp:</strong> Enter date in format YYYY-MM-DD HH:MM:SS to get Unix timestamp, or click "Get Current Timestamp" to get the current server timestamp</li>
        </ul>
        <p style="margin-top: 1rem; color: var(--text-secondary);">
            <strong>Note:</strong> Timestamps are in UTC. Dates can be entered in various formats (YYYY-MM-DD, DD/MM/YYYY, etc.). The "Get Current" buttons use the server's current time.
        </p>
    </div>
</div>

<a href="{% url 'utilities:index' %}" class="btn btn-secondary">← Back to Utilities</a>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const conversionType = document.getElementById('conversion_type');
    const inputLabel = document.getElementById('input_label');
    const inputValue = document.getElementById('input_value');
    const inputHint = document.getElementById('input_hint');
    
    const getCurrentTimestamp = document.getElementById('get-current-timestamp');
    const getCurrentDate = document.getElementById('get-current-date');
    
    function updateUI() {
        if (conversionType.value === 'timestamp_to_date') {
            inputLabel.textContent = 'Enter Timestamp';
            inputValue.placeholder = '1699123456';
            inputHint.textContent = 'Enter Unix timestamp (seconds or milliseconds)';
            getCurrentTimestamp.style.display = 'none';
            getCurrentDate.style.display = 'inline-block';
        } else {
            inputLabel.textContent = 'Enter Date';
            inputValue.placeholder = '2023-11-04 12:34:56';
            inputHint.textContent = 'Enter date in format YYYY-MM-DD HH:MM:SS or DD/MM/YYYY';
            getCurrentTimestamp.style.display = 'inline-block';
            getCurrentDate.style.display = 'none';
        }
    }
    
    conversionType.addEventListener('change', updateUI);
    updateUI(); // Initialize on page load
    
    // Handle "Get Current" buttons - submit form programmatically
    const form = document.querySelector('.converter-tool');
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Prevent duplicate submissions
    let isSubmitting = false;
    
    // Handle "Get Current" buttons using fetch API to bypass all validation
    getCurrentTimestamp.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (isSubmitting) {
            console.log('Already submitting, ignoring duplicate click');
            return;
        }
        
        isSubmitting = true;
        getCurrentTimestamp.disabled = true;
        getCurrentDate.disabled = true;
        
        // Create FormData with all form fields
        const formData = new FormData(form);
        formData.set('get_current', 'timestamp');
        formData.delete('input_value'); // Remove input_value to avoid validation
        
        // Submit via fetch - completely bypasses HTML5 validation
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error('Server error: ' + response.status + ' - ' + text.substring(0, 100));
                });
            }
            return response.text();
        })
        .then(html => {
            // Parse the response HTML and update the page
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newCard = doc.querySelector('.card');
            const currentCard = document.querySelector('.card');
            
            if (newCard && currentCard) {
                currentCard.innerHTML = newCard.innerHTML;
                
                // Re-run timezone conversion if result exists
                const resultDiv = document.querySelector('.alert-success');
                if (resultDiv) {
                    const isoElement = resultDiv.querySelector('p:last-child');
                    if (isoElement && isoElement.textContent.includes('ISO:')) {
                        const isoMatch = isoElement.textContent.match(/ISO:\s*(.+)/);
                        if (isoMatch) {
                            const isoString = isoMatch[1].trim();
                            try {
                                const date = new Date(isoString);
                                const localTimeString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                                const timeZoneOffset = -date.getTimezoneOffset();
                                const offsetHours = Math.floor(Math.abs(timeZoneOffset) / 60);
                                const offsetMinutes = Math.abs(timeZoneOffset) % 60;
                                const offsetSign = timeZoneOffset >= 0 ? '+' : '-';
                                const offsetString = `${offsetSign}${String(offsetHours).padStart(2, '0')}:${String(offsetMinutes).padStart(2, '0')}`;
                                let timeZoneName = '';
                                try {
                                    timeZoneName = Intl.DateTimeFormat().resolvedOptions().timeZone;
                                } catch (e) {
                                    timeZoneName = offsetString;
                                }
                                const localTimeEl = document.getElementById('local-time');
                                const localTimezoneEl = document.getElementById('local-timezone');
                                if (localTimeEl) localTimeEl.textContent = localTimeString;
                                if (localTimezoneEl) localTimezoneEl.textContent = timeZoneName + ' (' + offsetString + ')';
                            } catch (e) {
                                console.error('Error converting to local time:', e);
                            }
                        }
                    }
                }
                
                // Scroll to top to show results
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // Fallback: reload page
                window.location.reload();
            }
            
            isSubmitting = false;
            getCurrentTimestamp.disabled = false;
            getCurrentDate.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error getting current timestamp. Please try again.');
            isSubmitting = false;
            getCurrentTimestamp.disabled = false;
            getCurrentDate.disabled = false;
        });
    });
    
    getCurrentDate.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (isSubmitting) {
            console.log('Already submitting, ignoring duplicate click');
            return;
        }
        
        isSubmitting = true;
        getCurrentTimestamp.disabled = true;
        getCurrentDate.disabled = true;
        
        // Create FormData with all form fields
        const formData = new FormData(form);
        formData.set('get_current', 'date');
        formData.delete('input_value'); // Remove input_value to avoid validation
        
        // Submit via fetch - completely bypasses HTML5 validation
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error('Server error: ' + response.status + ' - ' + text.substring(0, 100));
                });
            }
            return response.text();
        })
        .then(html => {
            // Parse the response HTML and update the page
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newCard = doc.querySelector('.card');
            const currentCard = document.querySelector('.card');
            
            if (newCard && currentCard) {
                currentCard.innerHTML = newCard.innerHTML;
                
                // Re-run timezone conversion if result exists
                const resultDiv = document.querySelector('.alert-success');
                if (resultDiv) {
                    const isoElement = resultDiv.querySelector('p:last-child');
                    if (isoElement && isoElement.textContent.includes('ISO:')) {
                        const isoMatch = isoElement.textContent.match(/ISO:\s*(.+)/);
                        if (isoMatch) {
                            const isoString = isoMatch[1].trim();
                            try {
                                const date = new Date(isoString);
                                const localTimeString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                                const timeZoneOffset = -date.getTimezoneOffset();
                                const offsetHours = Math.floor(Math.abs(timeZoneOffset) / 60);
                                const offsetMinutes = Math.abs(timeZoneOffset) % 60;
                                const offsetSign = timeZoneOffset >= 0 ? '+' : '-';
                                const offsetString = `${offsetSign}${String(offsetHours).padStart(2, '0')}:${String(offsetMinutes).padStart(2, '0')}`;
                                let timeZoneName = '';
                                try {
                                    timeZoneName = Intl.DateTimeFormat().resolvedOptions().timeZone;
                                } catch (e) {
                                    timeZoneName = offsetString;
                                }
                                const localTimeEl = document.getElementById('local-time');
                                const localTimezoneEl = document.getElementById('local-timezone');
                                if (localTimeEl) localTimeEl.textContent = localTimeString;
                                if (localTimezoneEl) localTimezoneEl.textContent = timeZoneName + ' (' + offsetString + ')';
                            } catch (e) {
                                console.error('Error converting to local time:', e);
                            }
                        }
                    }
                }
                
                // Scroll to top to show results
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // Fallback: reload page
                window.location.reload();
            }
            
            isSubmitting = false;
            getCurrentTimestamp.disabled = false;
            getCurrentDate.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error getting current date. Please try again.');
            isSubmitting = false;
            getCurrentTimestamp.disabled = false;
            getCurrentDate.disabled = false;
        });
    });
    
    // Validate input for regular "Convert" button only
    form.addEventListener('submit', function(e) {
        // Only validate for regular convert button
        if (!inputValue.value.trim()) {
            e.preventDefault();
            alert('Please enter a value');
            return false;
        }
    });
    
    // Convert UTC time to user's local timezone
    {% if result and result.type == 'date' %}
    (function() {
        const isoString = '{{ result.iso }}';
        if (isoString) {
            try {
                // Create Date object from ISO string (automatically converts to local timezone)
                const date = new Date(isoString);
                
                // Format local time (get* methods return local time)
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                const localTimeString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                
                // Get timezone offset
                const timeZoneOffset = -date.getTimezoneOffset();
                const offsetHours = Math.floor(Math.abs(timeZoneOffset) / 60);
                const offsetMinutes = Math.abs(timeZoneOffset) % 60;
                const offsetSign = timeZoneOffset >= 0 ? '+' : '-';
                const offsetString = `${offsetSign}${String(offsetHours).padStart(2, '0')}:${String(offsetMinutes).padStart(2, '0')}`;
                
                // Get timezone name if available
                let timeZoneName = '';
                try {
                    timeZoneName = Intl.DateTimeFormat().resolvedOptions().timeZone;
                } catch (e) {
                    timeZoneName = offsetString;
                }
                
                document.getElementById('local-time').textContent = localTimeString;
                document.getElementById('local-timezone').textContent = timeZoneName + ' (' + offsetString + ')';
            } catch (e) {
                console.error('Error converting to local time:', e);
            }
        }
    })();
    {% endif %}
});
</script>
{% endblock %}
{% endblock %}



