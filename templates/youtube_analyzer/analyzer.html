{% extends 'base.html' %}
{% load static %}

{% block title %}Video URL Analyzer - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}Free YouTube video analyzer - extract metadata, SEO analysis, thumbnails, and more. Professional video analysis tool.{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Video URL Analyzer</h1>
    <p>Paste a YouTube URL to analyze video metadata, SEO, thumbnails, and more</p>
    
    <!-- Input Section -->
    <div class="analyzer-input-section" style="margin: 2rem 0; padding: 2rem; background: var(--surface); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <form id="analyzer-form" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
            {% csrf_token %}
            <div style="flex: 1; min-width: 300px;">
                <label for="youtube-url" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Paste YouTube URL</label>
                <input 
                    type="url" 
                    id="youtube-url" 
                    name="url" 
                    placeholder="https://www.youtube.com/watch?v=..." 
                    required
                    style="width: 100%; padding: 1rem; font-size: 1rem; border: 2px solid var(--border-color); border-radius: 8px; background: white;"
                >
            </div>
            <div>
                <button type="submit" id="analyze-btn" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1rem; white-space: nowrap;">
                    <span id="analyze-btn-text">Analyze Video</span>
                    <span id="analyze-btn-spinner" style="display: none; margin-left: 0.5rem;">‚è≥</span>
                </button>
            </div>
        </form>
    </div>
    
    <!-- Error Message -->
    <div id="error-message" class="alert alert-error" style="display: none; margin: 1rem 0;"></div>
    
    <!-- Results Container -->
    <div id="results-container" style="display: none;">
        
        <!-- 1. Video Preview Card -->
        <div class="result-card" style="margin: 2rem 0; padding: 2rem; background: var(--surface); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üìπ</span> Video Preview
            </h2>
            <div id="video-preview-content" style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; align-items: start;">
                <div>
                    <img id="video-thumbnail" src="" alt="Video thumbnail" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <a id="thumbnail-download" href="" download class="btn btn-secondary" style="width: 100%; margin-top: 1rem; display: none;">
                        Download Thumbnail
                    </a>
                </div>
                <div>
                    <h3 id="video-title" style="margin-top: 0; font-size: 1.5rem;"></h3>
                    <div id="channel-info" style="margin: 1rem 0;">
                        <p style="margin: 0.5rem 0;">
                            <strong>Channel:</strong> 
                            <a id="channel-link" href="" target="_blank" style="color: var(--primary-color);"></a>
                        </p>
                        <p style="margin: 0.5rem 0;">
                            <strong>Subscribers:</strong> 
                            <span id="channel-subs"></span>
                        </p>
                    </div>
                    <div id="key-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <div style="padding: 1rem; background: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Views</div>
                            <div id="stat-views" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);"></div>
                        </div>
                        <div style="padding: 1rem; background: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Likes</div>
                            <div id="stat-likes" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);"></div>
                        </div>
                        <div style="padding: 1rem; background: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Comments</div>
                            <div id="stat-comments" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 2. Metadata Card (Collapsible) -->
        <div class="result-card" style="margin: 2rem 0; padding: 2rem; background: var(--surface); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleCard(this)">
                <span><span>üìã</span> Metadata</span>
                <span class="toggle-icon">‚ñº</span>
            </h2>
            <div class="card-content">
                <table style="width: 100%; border-collapse: collapse;">
                    <tbody id="metadata-table">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 3. Thumbnail Extraction Card -->
        <div class="result-card" style="margin: 2rem 0; padding: 2rem; background: var(--surface); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üñºÔ∏è</span> Thumbnail Extraction
            </h2>
            <div id="thumbnails-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        
        <!-- 4. SEO Analysis Card -->
        <div class="result-card" style="margin: 2rem 0; padding: 2rem; background: var(--surface); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üîç</span> SEO Analysis
            </h2>
            
            <!-- SEO Scores -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>Title Score</strong>
                        <span id="title-score-value">0/100</span>
                    </div>
                    <div style="height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden;">
                        <div id="title-score-bar" style="height: 100%; background: var(--primary-color); width: 0%; transition: width 0.5s;"></div>
                    </div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>Description Score</strong>
                        <span id="desc-score-value">0/100</span>
                    </div>
                    <div style="height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden;">
                        <div id="desc-score-bar" style="height: 100%; background: var(--primary-color); width: 0%; transition: width 0.5s;"></div>
                    </div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>Tag Score</strong>
                        <span id="tag-score-value">0/100</span>
                    </div>
                    <div style="height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden;">
                        <div id="tag-score-bar" style="height: 100%; background: var(--primary-color); width: 0%; transition: width 0.5s;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Keyword Cloud -->
            <div style="margin-bottom: 2rem;">
                <h3>Keyword Density</h3>
                <div id="keyword-cloud" style="display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 1rem; background: white; border-radius: 8px; min-height: 100px;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <div style="margin-top: 1rem; padding: 0.75rem; background: #dbeafe; border-radius: 6px;">
                <strong>Estimated Ranking Difficulty:</strong> <span id="ranking-difficulty">-</span>
            </div>
        </div>
        
        <!-- 5. Format Info Card -->
        <div class="result-card" style="margin: 2rem 0; padding: 2rem; background: var(--surface); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üé¨</span> Video Format Information
            </h2>
            <div id="formats-list" style="display: grid; gap: 1rem;">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        
    </div>
</div>

<a href="{% url 'youtube_analyzer:index' %}" class="btn btn-secondary" style="margin-top: 2rem;">‚Üê Back to YouTube Analyzer</a>

{% endblock %}

{% block extra_js %}
<script>
let currentVideoData = null;
let currentVideoId = null;

// Toggle collapsible cards
function toggleCard(header) {
    const card = header.closest('.result-card');
    const content = card.querySelector('.card-content');
    const icon = header.querySelector('.toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

// Format numbers
function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
}

// Format duration
function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

// Format date
function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    try {
        const year = dateStr.substring(0, 4);
        const month = dateStr.substring(4, 6);
        const day = dateStr.substring(6, 8);
        return new Date(`${year}-${month}-${day}`).toLocaleDateString();
    } catch {
        return dateStr;
    }
}

// Handle form submission
document.getElementById('analyzer-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const url = document.getElementById('youtube-url').value;
    const analyzeBtn = document.getElementById('analyze-btn');
    const analyzeBtnText = document.getElementById('analyze-btn-text');
    const analyzeBtnSpinner = document.getElementById('analyze-btn-spinner');
    const errorMessage = document.getElementById('error-message');
    const resultsContainer = document.getElementById('results-container');
    
    // Show loading state
    analyzeBtn.disabled = true;
    analyzeBtnText.textContent = 'Analyzing...';
    analyzeBtnSpinner.style.display = 'inline';
    errorMessage.style.display = 'none';
    resultsContainer.style.display = 'none';
    
    try {
        const formData = new FormData();
        formData.append('url', url);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        const response = await fetch('{% url "youtube_analyzer:analyze" %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Failed to analyze video');
        }
        
        currentVideoData = data;
        currentVideoId = data.video_id;
        
        // Display results
        displayResults(data);
        resultsContainer.style.display = 'block';
        resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
    } catch (error) {
        errorMessage.textContent = error.message;
        errorMessage.style.display = 'block';
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtnText.textContent = 'Analyze Video';
        analyzeBtnSpinner.style.display = 'none';
    }
});

// Display all results
function displayResults(data) {
    displayVideoPreview(data);
    displayMetadata(data);
    displayThumbnails(data);
    displaySEOAnalysis(data);
    displayFormats(data);
}

// 1. Video Preview
function displayVideoPreview(data) {
    const thumbnail = data.thumbnails?.best || '';
    const title = data.basic_metadata?.title || 'N/A';
    const channel = data.channel || {};
    
    document.getElementById('video-thumbnail').src = thumbnail;
    document.getElementById('video-title').textContent = title;
    document.getElementById('channel-link').href = channel.url || '#';
    document.getElementById('channel-link').textContent = channel.name || 'N/A';
    document.getElementById('channel-subs').textContent = formatNumber(channel.subscriber_count || 0);
    
    const engagement = data.engagement || {};
    document.getElementById('stat-views').textContent = formatNumber(engagement.views || 0);
    document.getElementById('stat-likes').textContent = formatNumber(engagement.likes || 0);
    document.getElementById('stat-comments').textContent = formatNumber(engagement.comments || 0);
    
    if (thumbnail) {
        const downloadUrl = `{% url 'youtube_analyzer:download_thumbnail' %}?url=${encodeURIComponent(thumbnail)}&video_id=${data.video_id || ''}`;
        document.getElementById('thumbnail-download').href = downloadUrl;
        document.getElementById('thumbnail-download').style.display = 'block';
    }
}

// 2. Metadata
function displayMetadata(data) {
    const meta = data.basic_metadata || {};
    const channel = data.channel || {};
    const engagement = data.engagement || {};
    
    const metadata = [
        ['Title', meta.title || 'N/A'],
        ['Channel', channel.name || 'N/A'],
        ['Channel URL', channel.url || 'N/A'],
        ['Description', meta.description || 'N/A'],
        ['Tags', (meta.tags || []).join(', ') || 'N/A'],
        ['Publication Date', formatDate(meta.published_date)],
        ['Duration', formatDuration(meta.duration || 0)],
        ['Category', meta.category || 'N/A'],
        ['Views', formatNumber(engagement.views || 0)],
        ['Likes', formatNumber(engagement.likes || 0)],
        ['Comments', formatNumber(engagement.comments || 0)],
    ];
    
    const tableBody = document.getElementById('metadata-table');
    tableBody.innerHTML = metadata.map(([key, value]) => `
        <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 0.75rem; font-weight: 600; width: 200px;">${key}</td>
            <td style="padding: 0.75rem;">${value}</td>
        </tr>
    `).join('');
}

// 3. Thumbnails
function displayThumbnails(data) {
    const thumbnails = data.thumbnails?.all || [];
    const best = data.thumbnails?.best || '';
    
    const grid = document.getElementById('thumbnails-grid');
    
    // Deduplicate thumbnails by resolution (width x height) to avoid duplicates
    const uniqueThumbnails = [];
    const seenResolutions = new Set();
    const seenUrls = new Set();
    
    // Process all thumbnails, deduplicating by resolution
    for (const thumb of thumbnails) {
        if (!thumb.url || !thumb.width || !thumb.height) continue;
        
        const resolution = `${thumb.width}x${thumb.height}`;
        const url = thumb.url.split('?')[0]; // Normalize URL
        
        // Skip if we've already seen this resolution or this exact URL
        if (!seenResolutions.has(resolution) && !seenUrls.has(thumb.url)) {
            seenResolutions.add(resolution);
            seenUrls.add(thumb.url);
            uniqueThumbnails.push(thumb);
        }
    }
    
    // Check if best thumbnail is already included
    if (best) {
        const bestIncluded = uniqueThumbnails.some(t => t.url === best);
        if (!bestIncluded) {
            // Find best thumbnail in original list or use default
            const bestThumb = thumbnails.find(t => t.url === best);
            if (bestThumb) {
                const resolution = `${bestThumb.width}x${bestThumb.height}`;
                if (!seenResolutions.has(resolution)) {
                    uniqueThumbnails.unshift(bestThumb);
                    seenResolutions.add(resolution);
                }
            }
        }
    }
    
    // Sort by resolution (largest first)
    uniqueThumbnails.sort((a, b) => (b.width * b.height) - (a.width * a.height));
    
    if (uniqueThumbnails.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary);">No thumbnails available</p>';
        return;
    }
    
    const downloadBaseUrl = '{% url "youtube_analyzer:download_thumbnail" %}';
    const videoId = currentVideoId || '';
    
    grid.innerHTML = uniqueThumbnails.map(thumb => {
        const downloadUrl = `${downloadBaseUrl}?url=${encodeURIComponent(thumb.url)}&video_id=${videoId}`;
        return `
        <div style="text-align: center;">
            <img src="${thumb.url}" alt="Thumbnail" style="width: 100%; border-radius: 8px; margin-bottom: 0.5rem; max-height: 200px; object-fit: contain;">
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0.25rem 0;">${thumb.width} √ó ${thumb.height}</p>
            <a href="${downloadUrl}" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem; padding: 0.5rem;">Download</a>
        </div>
        `;
    }).join('');
}

// 4. SEO Analysis
function displaySEOAnalysis(data) {
    const seo = data.seo_analysis || {};
    
    // Update score bars
    const titleScore = seo.title_score || 0;
    const descScore = seo.description_score || 0;
    const tagScore = seo.tag_score || 0;
    
    document.getElementById('title-score-value').textContent = `${titleScore}/100`;
    document.getElementById('title-score-bar').style.width = `${titleScore}%`;
    
    document.getElementById('desc-score-value').textContent = `${descScore}/100`;
    document.getElementById('desc-score-bar').style.width = `${descScore}%`;
    
    document.getElementById('tag-score-value').textContent = `${tagScore}/100`;
    document.getElementById('tag-score-bar').style.width = `${tagScore}%`;
    
    // Keyword cloud
    const keywordCloud = document.getElementById('keyword-cloud');
    const keywords = seo.keyword_density || {};
    const sortedKeywords = Object.entries(keywords).sort((a, b) => b[1] - a[1]).slice(0, 20);
    
    if (sortedKeywords.length === 0) {
        keywordCloud.innerHTML = '<p style="color: var(--text-secondary);">No keywords available</p>';
    } else {
        const maxCount = sortedKeywords[0][1];
        keywordCloud.innerHTML = sortedKeywords.map(([word, count]) => {
            const size = Math.max(12, 12 + (count / maxCount) * 16);
            return `<span style="font-size: ${size}px; padding: 0.25rem 0.5rem; background: #e0f2fe; border-radius: 4px;">${word} (${count})</span>`;
        }).join('');
    }
    
    document.getElementById('ranking-difficulty').textContent = seo.estimated_difficulty || 'Unknown';
}

// 5. Formats
function displayFormats(data) {
    const formats = data.formats || [];
    const formatsList = document.getElementById('formats-list');
    
    if (formats.length === 0) {
        formatsList.innerHTML = '<p style="color: var(--text-secondary);">No format information available</p>';
        return;
    }
    
    formatsList.innerHTML = formats.map(fmt => `
        <div style="padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border-color);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div><strong>Resolution:</strong> ${fmt.resolution || 'N/A'}</div>
                <div><strong>FPS:</strong> ${fmt.fps || 'N/A'}</div>
                <div><strong>Codec:</strong> ${fmt.vcodec || 'N/A'}</div>
                <div><strong>Bitrate:</strong> ${fmt.tbr ? fmt.tbr + ' kbps' : 'N/A'}</div>
            </div>
        </div>
    `).join('');
}

</script>
{% endblock %}

