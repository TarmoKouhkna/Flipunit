{% extends 'base.html' %}
{% load static %}

{% block title %}Pick Color from Image - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}Upload an image and pick colors from it. Extract color codes from any image.{% endblock %}

{% block extra_css %}
<style>
    .upload-section {
        background: var(--surface);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .file-upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }
    
    .file-upload-area:hover {
        border-color: var(--primary-color);
        background: #f8fafc;
    }
    
    .file-upload-area.dragover {
        border-color: var(--primary-color);
        background: #e0f2fe;
    }
    
    .image-preview-container {
        position: relative;
        display: none;
        margin-top: 2rem;
    }
    
    .image-preview-container.active {
        display: block;
    }
    
    .image-preview {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        cursor: crosshair;
        display: block;
        margin: 0 auto;
    }
    
    .color-result-section {
        background: var(--surface);
        border-radius: 12px;
        padding: 2rem;
        margin-top: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: none;
    }
    
    .color-result-section.active {
        display: block;
    }
    
    .selected-color-display {
        width: 100%;
        aspect-ratio: 2;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        margin-bottom: 2rem;
    }
    
    .selected-color-display.light {
        color: #333;
    }
    
    .color-hex-large {
        font-size: 2rem;
        font-family: monospace;
        margin-bottom: 0.5rem;
    }
    
    .color-name {
        font-size: 1rem;
        opacity: 0.9;
    }
    
    .color-formats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--gap-md, 1rem);
    }
    
    .format-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-color);
    }
    
    .format-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .format-value {
        font-family: monospace;
        color: var(--text-primary);
        font-size: 0.95rem;
    }
    
    .copy-btn {
        padding: 0.5rem;
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .copy-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    
    
    @media (max-width: 768px) {
        .color-formats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
        <h1 class="card-title">Pick Color from Image</h1>
        <p>Upload an image and click on it to pick colors</p>
        
        <div class="upload-section">
            <div class="file-upload-area" id="fileUploadArea">
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">üìÅ</p>
                <p style="font-weight: 600; margin-bottom: 0.5rem;">Click to select or drag and drop</p>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Supports: JPG, PNG, WebP, GIF</p>
            </div>
            
            <div class="image-preview-container" id="imagePreviewContainer">
                <img id="imagePreview" class="image-preview" alt="Uploaded image">
            </div>
        </div>
        
        <div class="color-result-section" id="colorResultSection">
            <div class="selected-color-display" id="selectedColorDisplay">
                <div class="color-hex-large" id="colorHexLarge">#000000</div>
                <div class="color-name" id="colorName"></div>
            </div>
            
            <div class="color-formats-grid" id="colorFormatsGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
</div>

<a href="{% url 'color_picker:index' %}" class="btn btn-secondary">‚Üê Back to Color Picker</a>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/color-picker.js' %}"></script>
<script>
(function() {
    'use strict';
    
    // Reuse color conversion functions from color-picker.js
    // They're already loaded, so we can access them
    
    const fileUploadArea = document.getElementById('fileUploadArea');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const colorResultSection = document.getElementById('colorResultSection');
    const selectedColorDisplay = document.getElementById('selectedColorDisplay');
    const colorHexLarge = document.getElementById('colorHexLarge');
    const colorName = document.getElementById('colorName');
    const colorFormatsGrid = document.getElementById('colorFormatsGrid');
    
    let canvas = null;
    let ctx = null;
    
    // File upload handling (click is handled by main.js)
    imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            loadImage(file);
        }
    });
    
    // Drag and drop
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });
    
    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.classList.remove('dragover');
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            loadImage(file);
        }
    });
    
    function loadImage(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreviewContainer.classList.add('active');
            
            // Create canvas for color picking
            imagePreview.onload = () => {
                canvas = document.createElement('canvas');
                canvas.width = imagePreview.naturalWidth;
                canvas.height = imagePreview.naturalHeight;
                ctx = canvas.getContext('2d');
                ctx.drawImage(imagePreview, 0, 0);
            };
        };
        reader.readAsDataURL(file);
    }
    
    // Color picking from image
    imagePreview.addEventListener('click', (e) => {
        if (!canvas || !ctx) return;
        
        const rect = imagePreview.getBoundingClientRect();
        const scaleX = imagePreview.naturalWidth / rect.width;
        const scaleY = imagePreview.naturalHeight / rect.height;
        
        const x = Math.floor((e.clientX - rect.left) * scaleX);
        const y = Math.floor((e.clientY - rect.top) * scaleY);
        
        const imageData = ctx.getImageData(x, y, 1, 1);
        const [r, g, b] = imageData.data;
        
        // Use the ColorConverter from color-picker.js
        // Since it's in a closure, we'll recreate the conversion functions here
        const hex = rgbToHex(r, g, b);
        updateColorDisplay(r, g, b, hex);
    });
    
    function rgbToHex(r, g, b) {
        return "#" + [r, g, b].map(x => {
            const hex = x.toString(16);
            return hex.length === 1 ? "0" + hex : hex;
        }).join("");
    }
    
    function rgbToHsl(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        
        if (max === min) {
            h = s = 0;
        } else {
            const d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
                case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                case g: h = ((b - r) / d + 2) / 6; break;
                case b: h = ((r - g) / d + 4) / 6; break;
            }
        }
        
        return {
            h: Math.round(h * 360),
            s: Math.round(s * 100),
            l: Math.round(l * 100)
        };
    }
    
    function rgbToCmyk(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        const k = 1 - Math.max(r, g, b);
        if (k === 1) return { c: 0, m: 0, y: 0, k: 100 };
        const c = (1 - r - k) / (1 - k);
        const m = (1 - g - k) / (1 - k);
        const y = (1 - b - k) / (1 - k);
        return {
            c: Math.round(c * 100),
            m: Math.round(m * 100),
            y: Math.round(y * 100),
            k: Math.round(k * 100)
        };
    }
    
    function rgbToXyz(r, g, b) {
        r = r / 255;
        g = g / 255;
        b = b / 255;
        
        r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
        g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
        b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
        
        r *= 100;
        g *= 100;
        b *= 100;
        
        const x = r * 0.4124564 + g * 0.3575761 + b * 0.1804375;
        const y = r * 0.2126729 + g * 0.7151522 + b * 0.0721750;
        const z = r * 0.0193339 + g * 0.1191920 + b * 0.9503041;
        
        return {
            x: Math.round(x * 10) / 10,
            y: Math.round(y * 10) / 10,
            z: Math.round(z * 10) / 10
        };
    }
    
    function xyzToLab(x, y, z) {
        x /= 95.047;
        y /= 100.000;
        z /= 108.883;
        
        x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x + 16/116);
        y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y + 16/116);
        z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z + 16/116);
        
        const l = (116 * y) - 16;
        const a = 500 * (x - y);
        const b = 200 * (y - z);
        
        return {
            l: Math.round(l),
            a: Math.round(a),
            b: Math.round(b)
        };
    }
    
    function rgbToLab(r, g, b) {
        const xyz = rgbToXyz(r, g, b);
        return xyzToLab(xyz.x, xyz.y, xyz.z);
    }
    
    function rgbToLuv(r, g, b) {
        const xyz = rgbToXyz(r, g, b);
        const x = xyz.x / 100;
        const y = xyz.y / 100;
        const z = xyz.z / 100;
        
        const u = (4 * x) / (x + 15 * y + 3 * z);
        const v = (9 * y) / (x + 15 * y + 3 * z);
        
        const yn = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y + 16/116);
        const l = (116 * yn) - 16;
        
        const un = 0.197839824213;
        const vn = 0.468336302932;
        
        const u2 = 13 * l * (u - un);
        const v2 = 13 * l * (v - vn);
        
        return {
            l: Math.round(l),
            u: Math.round(u2),
            v: Math.round(v2)
        };
    }
    
    function rgbToHwb(r, g, b) {
        const hsl = rgbToHsl(r, g, b);
        const w = Math.min(r, g, b) / 255;
        const bl = 1 - (Math.max(r, g, b) / 255);
        return {
            h: hsl.h,
            w: Math.round(w * 100),
            b: Math.round(bl * 100)
        };
    }
    
    function updateColorDisplay(r, g, b, hex) {
        const hsl = rgbToHsl(r, g, b);
        const cmyk = rgbToCmyk(r, g, b);
        const xyz = rgbToXyz(r, g, b);
        const lab = rgbToLab(r, g, b);
        const luv = rgbToLuv(r, g, b);
        const hwb = rgbToHwb(r, g, b);
        
        // Update displays
        colorHexLarge.textContent = hex.toUpperCase();
        selectedColorDisplay.style.backgroundColor = hex;
        const isLight = (r + g + b) / 3 > 128;
        selectedColorDisplay.classList.toggle('light', isLight);
        colorName.textContent = '';
        
        // Update formats
        const formats = [
            { label: 'HEX', value: hex.toUpperCase() },
            { label: 'HSL', value: `${hsl.h}, ${hsl.s}, ${hsl.l}` },
            { label: 'RGB', value: `${r}, ${g}, ${b}` },
            { label: 'XYZ', value: `${xyz.x}, ${xyz.y}, ${xyz.z}` },
            { label: 'CMYK', value: `${cmyk.c}, ${cmyk.m}, ${cmyk.y}, ${cmyk.k}` },
            { label: 'LUV', value: `${luv.l}, ${luv.u}, ${luv.v}` },
            { label: 'LAB', value: `${lab.l}, ${lab.a}, ${lab.b}` },
            { label: 'HWB', value: `${hwb.h}, ${hwb.w}, ${hwb.b}` }
        ];
        
        colorFormatsGrid.innerHTML = formats.map(format => `
            <div class="format-item">
                <div>
                    <div class="format-label">${format.label}</div>
                    <div class="format-value">${format.value}</div>
                </div>
                <button class="copy-btn" data-value="${format.value}" title="Copy">
                    üìã
                </button>
            </div>
        `).join('');
        
        // Add copy functionality
        colorFormatsGrid.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const value = btn.getAttribute('data-value');
                navigator.clipboard.writeText(value).then(() => {
                    btn.textContent = '‚úì';
                    setTimeout(() => {
                        btn.textContent = 'üìã';
                    }, 1000);
                });
            });
        });
        
        colorResultSection.classList.add('active');
    }
})();
</script>
{% endblock %}
