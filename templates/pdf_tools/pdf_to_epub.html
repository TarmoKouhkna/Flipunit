{% extends 'base.html' %}

{% block title %}PDF to EPUB - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}Convert PDF files to EPUB format for e-readers. Support for multiple PDFs, text extraction, images, and proper EPUB structure.{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Convert PDF to EPUB</h1>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <form method="post" enctype="multipart/form-data" class="converter-tool" id="epubForm">
        {% csrf_token %}
        <div class="form-group">
            <label class="form-label">Select PDF Files</label>
            <input type="file" name="pdf_files" id="pdf_files" accept=".pdf" multiple style="display: none;">
            <div class="file-upload-area" id="uploadArea">
                <p style="margin-top: 1rem;">Click to select or drag and drop PDF files</p>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">You can select multiple files at once or add them one by one</p>
            </div>
        </div>
        
        <div id="fileListContainer" style="margin-top: 1.5rem; display: none;">
            <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">Selected Files (<span id="fileCount">0</span>)</h3>
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.75rem;">Drag files to reorder, or use ↑↓ buttons</p>
            <div id="fileList" class="file-list-scrollable">
                <!-- Files will be added here dynamically -->
            </div>
            <button type="button" class="btn btn-secondary" style="margin-top: 1rem; width: 100%;" onclick="clearAllFiles()">Clear All Files</button>
        </div>
        
        <div class="form-group" style="margin-top: 1.5rem;">
            <label class="form-label" for="epub_title">EPUB Title (optional)</label>
            <input type="text" name="epub_title" id="epub_title" class="form-control" placeholder="Enter EPUB title (default: PDF to EPUB Conversion)" maxlength="200" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--background); color: var(--text-primary); font-size: 1rem;">
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">This title will be used for the EPUB book metadata and filename.</p>
        </div>
        
        <div class="form-group" style="margin-top: 1.5rem;">
            <label class="form-label" for="cover_image">Cover Image (optional)</label>
            <input type="file" name="cover_image" id="cover_image" accept="image/*" style="display: none;">
            <div class="cover-upload-area" id="coverUploadArea" style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;">
                <p style="margin: 0; color: var(--text-secondary);">Click to select cover image</p>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.85rem;">PNG, JPG, JPEG, or WebP (max 5MB)</p>
            </div>
            <div id="coverPreview" style="margin-top: 1rem; display: none;">
                <img id="coverPreviewImg" src="" alt="Cover preview" style="max-width: 200px; max-height: 300px; border-radius: 6px; border: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" onclick="removeCoverImage()" style="margin-top: 0.5rem; display: block; width: 100%;">Remove Cover Image</button>
            </div>
        </div>
        
        <div class="form-group" style="margin-top: 1.5rem;">
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                <input type="checkbox" name="preserve_page_breaks" id="preserve_page_breaks" checked style="width: 18px; height: 18px; cursor: pointer;">
                <span style="color: var(--text-primary);">Preserve page breaks (each PDF page becomes a separate section)</span>
            </label>
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem; margin-left: 2rem;">Uncheck to have content flow continuously without page breaks</p>
        </div>
        
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary" id="download-btn" disabled style="flex: 1;">Convert to EPUB</button>
        </div>
    </form>
    
    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--surface); border-radius: 8px; border-left: 4px solid var(--primary-color);">
        <h3 style="margin-bottom: 0.75rem; color: var(--primary-color);">✨ Features</h3>
        <ul class="list-indent" style="color: var(--text-secondary); line-height: 1.8;">
            <li><strong>EPUB Format:</strong> Standard e-book format compatible with all e-readers</li>
            <li><strong>Multiple PDFs:</strong> Combine multiple PDF files into one EPUB book</li>
            <li><strong>Text Extraction:</strong> Preserves text content with proper formatting</li>
            <li><strong>Image Support:</strong> Extracts and embeds images from PDFs</li>
            <li><strong>Table Support:</strong> Preserves tables with proper formatting</li>
            <li><strong>Table of Contents:</strong> Automatic navigation structure</li>
            <li><strong>E-Reader Compatible:</strong> Works with Kindle, Kobo, Apple Books, and more</li>
        </ul>
    </div>
    
    <div style="margin-top: 2rem; padding: 1rem; background: var(--surface); border-radius: 6px;">
        <h3>How to use:</h3>
        <ol class="list-indent" style="margin-top: 0.5rem;">
            <li>Select one or multiple PDF files (max 50MB each)</li>
            <li>Add files one by one or select multiple at once</li>
            <li>Review your file list and remove any unwanted files</li>
            <li>Click "Convert to EPUB" to combine all PDFs into one EPUB file</li>
            <li>Download the EPUB file</li>
            <li>Open the EPUB file in your e-reader or e-book app</li>
        </ol>
        <p style="margin-top: 1rem; color: var(--text-secondary);">
            <strong>Note:</strong> The EPUB file is a standard e-book format that can be read on any e-reader or e-book app. 
            {% if not ebooklib_available %}
            <span style="color: #ff6b6b;">PDF to EPUB conversion requires ebooklib. Install with: pip install ebooklib</span>
            {% else %}
            Each PDF will become a chapter in the EPUB book. Text, images, and tables are preserved during conversion.
            {% endif %}
        </p>
    </div>
</div>

<a href="{% url 'pdf_tools:index' %}" class="btn btn-secondary">← Back to PDF Tools</a>

{% block extra_js %}
<style>
    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: var(--background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .file-item:hover {
        background: var(--surface);
        border-color: var(--primary-color);
    }
    
    .file-item-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .file-item-name {
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .file-item-size {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .file-item-remove {
        background: linear-gradient(135deg, rgba(234, 195, 195, 0.9) 0%, rgba(210, 121, 121, 0.9) 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: var(--font-size-base);
        font-weight: 500;
        transition: all var(--transition-base);
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .file-item-remove:hover {
        background: linear-gradient(135deg, rgba(234, 195, 195, 1) 0%, rgba(210, 121, 121, 1) 100%);
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(210, 121, 121, 0.2);
    }
    
    [data-theme="dark"] .file-item-remove {
        background: linear-gradient(90deg, rgba(92, 46, 46, 1) 0%, rgba(130, 28, 28, 1) 100%);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }
    
    [data-theme="dark"] .file-item-remove:hover {
        background: linear-gradient(90deg, rgba(92, 46, 46, 1) 0%, rgba(130, 28, 28, 1) 100%);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }
    
    @media (prefers-color-scheme: dark) {
        :root:not([data-theme="light"]) .file-item-remove {
            background: linear-gradient(90deg, rgba(92, 46, 46, 1) 0%, rgba(130, 28, 28, 1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        :root:not([data-theme="light"]) .file-item-remove:hover {
            background: linear-gradient(90deg, rgba(92, 46, 46, 1) 0%, rgba(130, 28, 28, 1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
    }
    
    .file-item-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .file-item-drag-handle {
        cursor: move;
        color: var(--text-secondary);
        font-size: 1.2rem;
        padding: 0.25rem 0.5rem;
        user-select: none;
    }
    
    .file-item-drag-handle:hover {
        color: var(--primary-color);
    }
    
    .file-item-move-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
    
    .file-item-move-btn:hover {
        background: #5a6268;
    }
    
    .file-item-move-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    .file-item.dragging {
        opacity: 0.5;
        border: 2px dashed var(--primary-color);
    }
    
    .file-item.drag-over {
        border-top: 3px solid var(--primary-color);
    }
    
    .file-upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .file-upload-area:hover {
        border-color: var(--primary-color);
        background: var(--surface);
    }
    
    .file-upload-area.dragover {
        border-color: var(--primary-color);
        background: var(--surface);
        transform: scale(1.02);
    }
    
    .file-upload-area input[type="file"] {
        display: none;
    }
    
    .file-list-scrollable {
        background: var(--surface);
        border-radius: 6px;
        padding: 1rem;
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
    }
    
    .file-list-scrollable::-webkit-scrollbar {
        width: 8px;
    }
    
    .file-list-scrollable::-webkit-scrollbar-track {
        background: var(--background);
        border-radius: 4px;
    }
    
    .file-list-scrollable::-webkit-scrollbar-thumb {
        background: var(--text-secondary);
        border-radius: 4px;
    }
    
    .file-list-scrollable::-webkit-scrollbar-thumb:hover {
        background: var(--primary-color);
    }
    
    .form-control {
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
</style>
<script>
let selectedFiles = [];
const maxFileSize = 50 * 1024 * 1024; // 50MB

document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('pdf_files');
    const uploadArea = document.getElementById('uploadArea');
    const fileListContainer = document.getElementById('fileListContainer');
    const fileList = document.getElementById('fileList');
    const fileCount = document.getElementById('fileCount');
    const form = document.getElementById('epubForm');
    
    // Cover image handling
    const coverImageInput = document.getElementById('cover_image');
    const coverUploadArea = document.getElementById('coverUploadArea');
    const coverPreview = document.getElementById('coverPreview');
    const coverPreviewImg = document.getElementById('coverPreviewImg');
    
    if (coverImageInput && coverUploadArea) {
        // Click to select cover image
        coverUploadArea.addEventListener('click', function(e) {
            e.preventDefault();
            coverImageInput.click();
        });
        
        // Handle cover image selection
        coverImageInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files.length > 0) {
                const file = e.target.files[0];
                
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Cover image exceeds 5MB limit. Please choose a smaller image.');
                    e.target.value = '';
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    e.target.value = '';
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    coverPreviewImg.src = e.target.result;
                    coverPreview.style.display = 'block';
                    coverUploadArea.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Drag and drop for cover image
        coverUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            coverUploadArea.classList.add('dragover');
        });
        
        coverUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            coverUploadArea.classList.remove('dragover');
        });
        
        coverUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            coverUploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                
                // Validate file size
                if (file.size > 5 * 1024 * 1024) {
                    alert('Cover image exceeds 5MB limit. Please choose a smaller image.');
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    return;
                }
                
                // Set file to input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                coverImageInput.files = dataTransfer.files;
                
                // Trigger change event
                coverImageInput.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // Remove cover image function
    window.removeCoverImage = function() {
        if (coverImageInput) {
            coverImageInput.value = '';
        }
        if (coverPreview) {
            coverPreview.style.display = 'none';
        }
        if (coverUploadArea) {
            coverUploadArea.style.display = 'block';
        }
        if (coverPreviewImg) {
            coverPreviewImg.src = '';
        }
    };
    
    // Click to select files
    uploadArea.addEventListener('click', function(e) {
        e.preventDefault();
        fileInput.click();
    });
    
    // Handle file selection
    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
        e.target.value = ''; // Reset input to allow selecting same files again
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
    
    function handleFiles(files) {
        let addedCount = 0;
        let skippedCount = 0;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                skippedCount++;
                continue;
            }
            
            // Check if file already exists
            const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
            if (exists) {
                skippedCount++;
                continue;
            }
            
            // Validate file size
            if (file.size > maxFileSize) {
                skippedCount++;
                continue;
            }
            
            // Add file to list
            selectedFiles.push(file);
            addedCount++;
        }
        
        if (addedCount > 0) {
            updateFileList();
        }
        
        if (skippedCount > 0) {
            alert(`Skipped ${skippedCount} file(s) - either not PDF, already added, or exceeds 50MB limit.`);
        }
    }
    
    function updateFileList() {
        fileList.innerHTML = '';
        
        if (selectedFiles.length === 0) {
            fileListContainer.style.display = 'none';
            document.getElementById('download-btn').disabled = true;
            return;
        }
        
        fileListContainer.style.display = 'block';
        fileCount.textContent = selectedFiles.length;
        document.getElementById('download-btn').disabled = false;
        
        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.draggable = true;
            fileItem.dataset.index = index;
            
            const size = formatFileSize(file.size);
            const isFirst = index === 0;
            const isLast = index === selectedFiles.length - 1;
            
            fileItem.innerHTML = `
                <div class="file-item-drag-handle" title="Drag to reorder">☰</div>
                <div class="file-item-info">
                    <span class="file-item-name">${escapeHtml(file.name)}</span>
                    <span class="file-item-size">${size}</span>
                </div>
                <div class="file-item-actions">
                    <button type="button" class="file-item-move-btn" onclick="moveFile(${index}, -1)" ${isFirst ? 'disabled' : ''} title="Move up">↑</button>
                    <button type="button" class="file-item-move-btn" onclick="moveFile(${index}, 1)" ${isLast ? 'disabled' : ''} title="Move down">↓</button>
                    <button type="button" class="file-item-remove" onclick="removeFile(${index})">Remove</button>
                </div>
            `;
            
            // Drag and drop handlers
            fileItem.addEventListener('dragstart', handleDragStart);
            fileItem.addEventListener('dragover', handleDragOver);
            fileItem.addEventListener('drop', handleDrop);
            fileItem.addEventListener('dragend', handleDragEnd);
            fileItem.addEventListener('dragleave', handleDragLeave);
            
            fileList.appendChild(fileItem);
        });
    }
    
    let draggedIndex = null;
    let dragOverIndex = null;
    
    function handleDragStart(e) {
        draggedIndex = parseInt(e.target.closest('.file-item').dataset.index);
        e.target.closest('.file-item').classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const item = e.target.closest('.file-item');
        if (item && item.dataset.index) {
            const overIndex = parseInt(item.dataset.index);
            if (overIndex !== dragOverIndex) {
                // Remove previous drag-over class
                document.querySelectorAll('.file-item.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
                item.classList.add('drag-over');
                dragOverIndex = overIndex;
            }
        }
    }
    
    function handleDragLeave(e) {
        e.target.closest('.file-item')?.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
        e.preventDefault();
        const item = e.target.closest('.file-item');
        if (item && draggedIndex !== null) {
            const dropIndex = parseInt(item.dataset.index);
            if (draggedIndex !== dropIndex) {
                // Reorder files
                const [movedFile] = selectedFiles.splice(draggedIndex, 1);
                selectedFiles.splice(dropIndex, 0, movedFile);
                updateFileList();
            }
        }
        dragOverIndex = null;
    }
    
    function handleDragEnd(e) {
        e.target.closest('.file-item')?.classList.remove('dragging');
        document.querySelectorAll('.file-item.drag-over').forEach(el => {
            el.classList.remove('drag-over');
        });
        draggedIndex = null;
        dragOverIndex = null;
    }
    
    window.moveFile = function(index, direction) {
        if ((direction === -1 && index === 0) || (direction === 1 && index === selectedFiles.length - 1)) {
            return;
        }
        const newIndex = index + direction;
        [selectedFiles[index], selectedFiles[newIndex]] = [selectedFiles[newIndex], selectedFiles[index]];
        updateFileList();
    };
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Download functionality
    const downloadBtn = document.getElementById('download-btn');
    const originalDownloadText = downloadBtn.textContent;
    
    form.addEventListener('submit', function(e) {
        if (selectedFiles.length === 0) {
            e.preventDefault();
            alert('Please select at least one PDF file.');
            return;
        }
        
        e.preventDefault();
        
        // Create FormData with all files
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', form.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Add EPUB title if provided
        const epubTitleInput = document.getElementById('epub_title');
        if (epubTitleInput && epubTitleInput.value.trim()) {
            formData.append('epub_title', epubTitleInput.value.trim());
        }
        
        // Add preserve page breaks option
        const preservePageBreaksCheckbox = document.getElementById('preserve_page_breaks');
        if (preservePageBreaksCheckbox && preservePageBreaksCheckbox.checked) {
            formData.append('preserve_page_breaks', 'on');
        }
        
        // Add cover image if provided
        const coverImageInput = document.getElementById('cover_image');
        if (coverImageInput && coverImageInput.files && coverImageInput.files.length > 0) {
            formData.append('cover_image', coverImageInput.files[0]);
        }
        
        selectedFiles.forEach((file) => {
            formData.append('pdf_files', file);
        });
        
        // Show loading state
        downloadBtn.textContent = 'Processing...';
        downloadBtn.disabled = true;
        
        // Submit using fetch
        fetch(form.action || window.location.pathname, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            // Check if response is successful
            if (!response.ok) {
                return response.text().then(text => {
                    // If it's an error page, reload to show messages
                    if (text.includes('alert alert-')) {
                        document.open();
                        document.write(text);
                        document.close();
                    } else {
                        throw new Error('Conversion failed');
                    }
                });
            }
            
            // Get filename from Content-Disposition header before converting to blob
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'converted.epub';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            // Get the response as blob
            return response.blob().then(blob => ({ blob, filename }));
        })
        .then(({ blob, filename }) => {
            if (blob) {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
            
            downloadBtn.textContent = originalDownloadText;
            downloadBtn.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            downloadBtn.textContent = originalDownloadText;
            downloadBtn.disabled = false;
        });
    });
    
    // Global functions
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
    };
    
    window.clearAllFiles = function() {
        if (confirm('Are you sure you want to remove all files?')) {
            selectedFiles = [];
            updateFileList();
        }
    };
});
</script>
{% endblock %}
{% endblock %}

