{% extends 'base.html' %}

{% block title %}Universal PDF Converter - Convert PDF to Images, HTML, Text - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}Free online PDF converter - Convert PDF to PNG, JPG, HTML, Text, SVG, RTF and vice versa. Fast, secure, no registration required.{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Universal PDF Converter - Convert PDF Files</h1>
    <p style="color: var(--text-secondary); margin-bottom: 2rem;">Convert between PDF and various formats</p>
    
    <form method="post" enctype="multipart/form-data" class="converter-tool" id="converter-form">
        {% csrf_token %}
        
        <div class="form-group">
            <label class="form-label">Output Format</label>
            <select name="output_format" id="output_format" class="form-control" required>
                <option value="">Select output format...</option>
                <optgroup label="From PDF">
                    <option value="png">PDF to PNG (Images)</option>
                    <option value="jpg">PDF to JPG (Images)</option>
                    <option value="jpg">PDF to JPEG (Images)</option>
                    <option value="html">PDF to HTML</option>
                    <option value="txt">PDF to Text</option>
                    <option value="svg">PDF to SVG</option>
                    <option value="rtf">PDF to RTF</option>
                </optgroup>
                <optgroup label="To PDF">
                    <option value="pdf">PNG to PDF</option>
                    <option value="pdf">JPG to PDF</option>
                    <option value="pdf">JPEG to PDF</option>
                    <option value="pdf">HTML to PDF</option>
                    <option value="pdf">Text to PDF</option>
                    <option value="pdf">SVG to PDF</option>
                    <option value="pdf">RTF to PDF</option>
                </optgroup>
            </select>
        </div>
        
        <div id="file-upload-section" class="form-group">
            <label class="form-label">Upload File</label>
            <div class="file-upload-area" id="upload-area" data-custom-handler="true">
                <input type="file" name="input_file" id="input_file" accept=".pdf,.html,.htm,.svg,.svgz,.rtf,.png,.jpg,.jpeg,.txt">
                <div id="upload-content">
                    <p style="margin-top: 1rem; font-size: 1.1rem;">üìÅ Click to select or drag and drop a file</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;" id="file-info">Supports: PDF, HTML, SVG, RTF, PNG, JPG, JPEG, TXT</p>
                </div>
            </div>
        </div>
        
        <div id="html-content-section" class="form-group" style="display: none;">
            <label class="form-label">Or Paste HTML Content</label>
            <textarea name="html_content" id="html_content" rows="10" class="form-control" placeholder="Enter your HTML content here... Example: &lt;h1&gt;Title&lt;/h1&gt;&lt;p&gt;Content&lt;/p&gt;"></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block" id="submit-btn">Convert</button>
    </form>
    
    <!-- Job Status Area (for async processing - PDF to Images) -->
    <div id="jobStatusArea" style="display: none; margin-top: 2rem; padding: 1.5rem; background: var(--surface); border-radius: 6px;">
        <div id="jobStatusMessage" style="text-align: center; font-size: 1.1rem; margin-bottom: 1rem;">
            <div class="spinner"></div> Processing...
        </div>
        <div id="jobIdDisplay" style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;"></div>
        <div id="jobError" style="display: none; color: var(--error-color); text-align: center; margin-top: 1rem;"></div>
    </div>
    
    <!-- Results Area (for completed async jobs - PDF to Images) -->
    <div id="resultsArea" style="display: none; margin-top: 2rem; padding: 1.5rem; background: var(--surface); border-radius: 6px;">
        <div style="text-align: center;">
            <h3 style="margin-bottom: 0.5rem; color: var(--success-color, #4caf50);">‚úÖ Conversion Completed!</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">Your PDF has been converted to images. Click below to download the ZIP file.</p>
            <a id="downloadBtn" href="#" class="btn btn-primary" style="min-width: 220px; font-size: 1rem;">‚¨áÔ∏è Download Images ZIP</a>
        </div>
    </div>
    
    <div style="margin-top: 2rem; padding: 1rem; background: var(--surface); border-radius: 6px;">
        <h3>Supported Conversions:</h3>
        <ul class="list-indent" style="margin-top: 0.5rem;">
            <li><strong>PDF to PNG/JPG/JPEG:</strong> Convert PDF pages to image files</li>
            <li><strong>PNG/JPG/JPEG to PDF:</strong> Convert image files to PDF</li>
            <li><strong>PDF to HTML:</strong> Convert PDF to HTML with preserved formatting and tables</li>
            <li><strong>HTML to PDF:</strong> Convert HTML files or content to PDF</li>
            <li><strong>PDF to Text:</strong> Extract plain text from PDF documents</li>
            <li><strong>Text to PDF:</strong> Convert text files to PDF</li>
            <li><strong>PDF to SVG:</strong> Convert PDF pages to SVG format</li>
            <li><strong>SVG to PDF:</strong> Convert SVG files to PDF</li>
            <li><strong>PDF to RTF:</strong> Convert PDF to RTF format</li>
            <li><strong>RTF to PDF:</strong> Convert RTF files to PDF</li>
        </ul>
    </div>
</div>

<a href="{% url 'pdf_tools:index' %}" class="btn btn-secondary">‚Üê Back to PDF Tools</a>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hide PyMuPDF error messages if PyMuPDF is available
    {% if pymupdf_available %}
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        const text = alert.textContent || alert.innerText || '';
        if (text.includes('PyMuPDF') || text.toLowerCase().includes('pymupdf')) {
            alert.style.display = 'none';
        }
    });
    {% endif %}
    
    const outputFormat = document.getElementById('output_format');
    const fileUploadSection = document.getElementById('file-upload-section');
    const htmlContentSection = document.getElementById('html_content');
    const htmlContentSectionDiv = document.getElementById('html-content-section');
    const inputFile = document.getElementById('input_file');
    const form = document.getElementById('converter-form');
    const submitBtn = document.getElementById('submit-btn');
    
    // Update accept attribute and show/hide sections based on output format
    outputFormat.addEventListener('change', function() {
        const format = this.value;
        
        if (format === 'pdf') {
            // All formats to PDF - accept all possible input formats
            inputFile.setAttribute('accept', '.html,.htm,.svg,.svgz,.rtf,.png,.jpg,.jpeg,.txt');
            fileUploadSection.style.display = 'block';
            // Show HTML content section only for HTML to PDF
            htmlContentSectionDiv.style.display = 'block';
            inputFile.required = false;
        } else if (format === 'png' || format === 'jpg' || format === 'html' || format === 'txt' || format === 'svg' || format === 'rtf') {
            // PDF to other formats
            inputFile.setAttribute('accept', '.pdf');
            fileUploadSection.style.display = 'block';
            htmlContentSectionDiv.style.display = 'none';
            inputFile.required = true;
        } else {
            fileUploadSection.style.display = 'block';
            htmlContentSectionDiv.style.display = 'none';
        }
    });
    
    // Handle file input change for HTML files and update display
    inputFile.addEventListener('change', function(e) {
        const fileInfo = document.getElementById('file-info');
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            // Update file info display
            if (fileInfo) {
                const fileSize = (file.size / 1024).toFixed(2);
                fileInfo.textContent = `Selected: ${file.name} (${fileSize} KB)`;
            }
            
            if (outputFormat.value === 'pdf') {
                // Only auto-fill textarea for HTML files
                if (file.type === 'text/html' || file.name.endsWith('.html') || file.name.endsWith('.htm')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        htmlContentSection.value = e.target.result;
                    };
                    reader.readAsText(file);
                } else {
                    // Clear textarea for non-HTML files
                    htmlContentSection.value = '';
                }
            }
        } else {
            if (fileInfo) {
                fileInfo.textContent = 'Supports: PDF, HTML, SVG, RTF, PNG, JPG, JPEG, TXT';
            }
        }
    });
    
    // Ensure file input is clickable - add explicit styling
    const uploadArea = document.getElementById('upload-area');
    if (uploadArea && inputFile) {
        // Make sure file input is accessible
        inputFile.style.display = 'block';
        inputFile.style.opacity = '0';
        inputFile.style.position = 'absolute';
        inputFile.style.width = '100%';
        inputFile.style.height = '100%';
        inputFile.style.cursor = 'pointer';
        inputFile.style.top = '0';
        inputFile.style.left = '0';
        inputFile.style.zIndex = '2';
        
        // Ensure upload area is clickable
        uploadArea.style.cursor = 'pointer';
        uploadArea.style.position = 'relative';
        
        // Add click handler (main.js will skip this due to data-custom-handler attribute)
        let isOpeningDialog = false;
        uploadArea.addEventListener('click', function(e) {
            if (e.target !== inputFile && !inputFile.contains(e.target)) {
                // Prevent any other handlers from running
                e.stopImmediatePropagation();
                e.stopPropagation();
                
                // Only open dialog if not already opening
                if (!isOpeningDialog) {
                    isOpeningDialog = true;
                    inputFile.click();
                    // Reset flag after dialog opens
                    setTimeout(() => {
                        isOpeningDialog = false;
                    }, 500);
                }
            }
        });
        
        // Stop propagation on file input click to prevent bubbling
        inputFile.addEventListener('click', function(e) {
            e.stopPropagation();
            e.stopImmediatePropagation();
        }, { capture: true });
    }
    
    // Handle form submission
    const originalText = submitBtn.textContent;
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate form before submission
        if (!outputFormat.value) {
            alert('Please select an output format.');
            return false;
        }
        
        if (!inputFile.files || inputFile.files.length === 0) {
            // Check if HTML content is provided for HTML to PDF
            if (outputFormat.value === 'pdf' && htmlContentSection.value.trim()) {
                // HTML to PDF - allow submission
            } else {
                alert('Please upload a file.');
                return false;
            }
        }
        
        // Check if this is PDF to Images (async operation)
        const isPdfToImages = outputFormat.value === 'png' || outputFormat.value === 'jpg' || outputFormat.value === 'jpeg';
        
        if (isPdfToImages) {
            // Use async pattern for PDF to Images
            submitBtn.textContent = 'Uploading...';
            submitBtn.disabled = true;
            
            // Hide previous results
            document.getElementById('resultsArea').style.display = 'none';
            document.getElementById('jobStatusArea').style.display = 'none';
            
            const formData = new FormData(form);
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                const response = await fetch(form.action || window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken,
                        'Accept': 'application/json'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                
                if (!response.ok) {
                    let errorMessage = 'Conversion failed';
                    try {
                        if (contentType?.includes('application/json')) {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorMessage;
                        }
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    throw new Error(errorMessage || `Server returned status ${response.status}`);
                }
                
                if (contentType?.includes('application/json')) {
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    if (data.job_id) {
                        // Async job created - start polling
                        submitBtn.textContent = 'Processing...';
                        document.getElementById('jobStatusArea').style.display = 'block';
                        document.getElementById('resultsArea').style.display = 'none';
                        document.getElementById('jobStatusMessage').innerHTML = '<div class="spinner"></div> Job created. Processing in background...';
                        document.getElementById('jobIdDisplay').textContent = `Job ID: ${data.job_id}`;
                        document.getElementById('jobError').style.display = 'none';
                        
                        startJobPolling(data.job_id);
                        return;
                    }
                }
                
                // Fallback: if not async, allow normal form submission
                form.submit();
                
            } catch (err) {
                console.error('Conversion error:', err);
                alert(err.message || 'Conversion failed. Please try again.');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        } else {
            // Synchronous operations - allow normal form submission
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;
            
            // Reset button after a delay (for file downloads that don't reload the page)
            setTimeout(function() {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }, 2000);
            
            // Allow normal form submission
            form.submit();
        }
    });
    
    // Job polling functions for async PDF to Images
    let pollInterval = null;
    
    function startJobPolling(jobId) {
        clearInterval(pollInterval);
        
        console.log('üîÑ Starting job polling for jobId:', jobId);
        pollInterval = setInterval(() => {
            fetch(`/pdf-tools/job/status/${jobId}/`)
                .then(response => response.json())
                .then(data => {
                    updateJobStatus(data);
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(pollInterval);
                        console.log('üõë Polling stopped, job status:', data.status);
                        
                        if (data.status === 'completed') {
                            console.log('‚úÖ Job completed, calling showConversionResult');
                            showConversionResult(data, jobId);
                        } else {
                            console.log('‚ùå Job failed');
                            showJobError(data.error_message || 'Conversion failed. Please try again.');
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }
                })
                .catch(error => {
                    console.error('Polling error:', error);
                });
        }, 2000); // Poll every 2 seconds
    }
    
    function updateJobStatus(data) {
        const jobStatusMessage = document.getElementById('jobStatusMessage');
        const jobIdDisplay = document.getElementById('jobIdDisplay');
        const jobError = document.getElementById('jobError');
        
        if (!jobStatusMessage || !jobIdDisplay || !jobError) return;
        
        jobIdDisplay.textContent = `Job ID: ${data.job_id}`;
        jobError.style.display = 'none';
        
        let statusText = '';
        let spinner = '<div class="spinner"></div>';
        
        switch (data.status) {
            case 'pending':
                statusText = `${spinner} Job created. Waiting to process...`;
                break;
            case 'processing':
                statusText = `${spinner} Converting PDF to images...`;
                break;
            case 'completed':
                statusText = '‚úÖ Conversion completed!';
                break;
            case 'failed':
                statusText = '‚ùå Conversion failed.';
                jobError.textContent = data.error_message || 'An unknown error occurred.';
                jobError.style.display = 'block';
                break;
            default:
                statusText = `${spinner} Unknown status: ${data.status}`;
        }
        jobStatusMessage.innerHTML = statusText;
    }
    
    function showConversionResult(data, jobId) {
        console.log('üéØ showConversionResult called with jobId:', jobId);
        const resultsArea = document.getElementById('resultsArea');
        const downloadBtn = document.getElementById('downloadBtn');
        
        if (!resultsArea || !downloadBtn) {
            console.error('‚ùå Results area or download button not found!');
            return;
        }
        
        console.log('‚úÖ Found results area and download button');
        
        downloadBtn.href = `/pdf-tools/job/download/${jobId}/`;
        console.log('‚úÖ Download link set to:', downloadBtn.href);
        
        downloadBtn.onclick = function resetButtonAfterDownload(e) {
            console.log('üîµüîµüîµ Download button clicked, resetting form button');
            
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            console.log('‚úÖ‚úÖ‚úÖ Form button reset');
            
            return true;
        };
        
        console.log('‚úÖ Download button onclick handler attached');
        
        resultsArea.style.display = 'block';
        document.getElementById('jobStatusArea').style.display = 'none';
        console.log('‚úÖ Results area displayed');
    }
    
    function showJobError(message) {
        const jobStatusMessage = document.getElementById('jobStatusMessage');
        const jobError = document.getElementById('jobError');
        if (!jobStatusMessage || !jobError) return;
        jobStatusMessage.innerHTML = '‚ùå Error occurred.';
        jobError.textContent = message;
        jobError.style.display = 'block';
    }
});
</script>
{% endblock %}

