{% extends 'base.html' %}

{% block title %}Audio Transcription - Transcribe Audio to Text Online - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}Free online audio transcription - Convert audio files (MP3, WAV, M4A, OGG) to text using AI. Automatic language detection. Fast, secure, no registration required.{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Audio Transcription - Convert Audio to Text</h1>
    <p>Transcribe audio files to text using AI-powered speech recognition</p>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    {% if not openai_available %}
    <div class="alert alert-error">
        OpenAI library is not installed. Please install with: pip install openai
    </div>
    {% endif %}
    
    <div class="privacy-notice">
        <p>
            <span>üîí</span>
            <span><strong>Privacy Notice:</strong> Your files are processed securely and are <strong>not stored</strong> on our servers.</span>
        </p>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="transcriptionForm">
        {% csrf_token %}
        <div class="form-group">
            <label class="form-label">Select Audio File</label>
            <div class="file-upload-area" id="uploadArea">
                <input type="file" name="audio_file" id="audio_file" accept="audio/*,.mp3,.wav,.m4a,.ogg" required>
                <div id="uploadContent">
                    <p style="margin-top: 1rem; font-size: 1.1rem;">üìÅ Click to select or drag and drop</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Supports: MP3, WAV, M4A, OGG (max 30 minutes)</p>
                </div>
            </div>
            <div id="durationInfo" style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.9rem; display: none;"></div>
            <div id="durationError" class="alert alert-error" style="display: none; margin-top: 1rem;"></div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block" id="submit-btn" style="margin-top: 1.5rem;">Transcribe Audio</button>
    </form>
    
    <!-- Job Status Display Area -->
    <div id="jobStatusArea" style="display: none; margin-top: 2rem;">
        <div class="card" style="background: var(--surface);">
            <div id="jobStatusContent">
                <!-- Status will be dynamically updated here -->
            </div>
        </div>
    </div>
    
    <!-- Results Display Area (for async results) -->
    <div id="resultsArea" style="display: none; margin-top: 2rem;">
        <h3>Transcription Result:</h3>
        <div id="languageInfo" style="display: none; background: var(--surface); padding: 1rem; border-radius: 6px; margin-top: 1rem; margin-bottom: 1rem;"></div>
        <div style="background: var(--surface); padding: 1.5rem; border-radius: 6px; margin-top: 1rem;">
            <textarea id="transcriptionText" class="form-control" rows="15" readonly style="font-family: monospace; white-space: pre-wrap;"></textarea>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
            <button onclick="copyTranscription()" class="btn btn-secondary">Copy to Clipboard</button>
            <button onclick="downloadTranscription()" class="btn btn-secondary">Download as .txt</button>
            {% if docx_available %}
            <button onclick="downloadDocx()" class="btn btn-primary" id="downloadDocxBtn">Download as .docx</button>
            {% endif %}
        </div>
    </div>
    
    <!-- Legacy template result display (for backward compatibility) -->
    {% if transcription %}
    <div style="margin-top: 2rem;">
        <h3>Transcription Result:</h3>
        {% if detected_language %}
        <div style="background: var(--surface); padding: 1rem; border-radius: 6px; margin-top: 1rem; margin-bottom: 1rem;">
            <strong style="color: var(--primary-color);">Detected Language:</strong>
            <span style="text-transform: uppercase;">{{ detected_language }}</span>
        </div>
        {% endif %}
        <div style="background: var(--surface); padding: 1.5rem; border-radius: 6px; margin-top: 1rem;">
            <textarea class="form-control" rows="15" readonly style="font-family: monospace; white-space: pre-wrap;">{{ transcription }}</textarea>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
            <button onclick="copyTranscription()" class="btn btn-secondary">Copy to Clipboard</button>
            <button onclick="downloadTranscription()" class="btn btn-secondary">Download as .txt</button>
            {% if docx_available %}
            <form method="post" action="{% url 'text_converter:download_transcription_docx' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="transcription" value="{{ transcription }}">
                <button type="submit" class="btn btn-primary">Download as .docx</button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <div style="margin-top: 2rem; padding: 1rem; background: var(--surface); border-radius: 6px;">
        <h3>How to use:</h3>
        <ol class="list-indent" style="margin-top: 0.5rem; color: var(--text-secondary); line-height: 1.8;">
            <li>Upload your audio file (MP3, WAV, M4A, or OGG format)</li>
            <li>File duration must be 30 minutes (1800 seconds) or less</li>
            <li>Click "Transcribe Audio" to start transcription</li>
            <li>Wait for the AI to process your audio (may take a few moments)</li>
            <li>Copy the transcribed text from the results</li>
        </ol>
        <p style="margin-top: 1rem; color: var(--text-secondary);">
            <strong>Note:</strong> If your audio file is longer than 30 minutes, use our <a href="{% url 'media_converter:audio_splitter' %}" style="color: var(--primary-color);">Audio Splitter tool</a> to split it into smaller segments first. If you have an audio file in a different format, use our <a href="{% url 'media_converter:audio_converter' %}" style="color: var(--primary-color);">Audio Converter tool</a> to convert it to MP3, WAV, M4A, or OGG format.
        </p>
    </div>
</div>

<a href="{% url 'text_converter:index' %}" class="btn btn-secondary">‚Üê Back to Text Converters</a>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('transcriptionForm');
    const fileInput = document.getElementById('audio_file');
    const uploadArea = document.getElementById('uploadArea');
    const uploadContent = document.getElementById('uploadContent');
    const durationInfo = document.getElementById('durationInfo');
    const durationError = document.getElementById('durationError');
    const submitBtn = document.getElementById('submit-btn');
    const MAX_DURATION = 30 * 60; // 30 minutes in seconds
    
    let audioDuration = null;
    let isValidDuration = false;
    
    // Update UI when file is selected
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadContent.querySelector('p').textContent = 'Selected: ' + file.name;
            
            // Validate file type
            const allowedTypes = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/x-m4a', 'audio/mp4', 'audio/mp4a-latm', 'audio/ogg', 'audio/vorbis'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            const allowedExts = ['.mp3', '.wav', '.m4a', '.ogg'];
            
            // Check by extension first (more reliable than MIME type)
            if (!allowedExts.includes(fileExt)) {
                // If extension doesn't match, check MIME type as fallback
                if (!allowedTypes.includes(file.type)) {
                    durationError.style.display = 'block';
                    durationError.innerHTML = 'Invalid file type. Please upload MP3, WAV, M4A, or OGG files.';
                    isValidDuration = false;
                    submitBtn.disabled = true;
                    return;
                }
            }
            
            // Check audio duration
            durationInfo.style.display = 'block';
            durationInfo.textContent = 'Checking audio duration...';
            durationError.style.display = 'none';
            isValidDuration = false;
            submitBtn.disabled = true;
            
            const audio = new Audio();
            const url = URL.createObjectURL(file);
            
            // Set timeout for duration check (some formats may take longer)
            const durationTimeout = setTimeout(function() {
                URL.revokeObjectURL(url);
                // If we can't determine duration client-side, allow upload (server will validate)
                durationInfo.textContent = 'File selected. Duration will be validated on server.';
                isValidDuration = true;
                submitBtn.disabled = false;
            }, 5000); // 5 second timeout
            
            audio.addEventListener('loadedmetadata', function() {
                clearTimeout(durationTimeout);
                audioDuration = audio.duration;
                URL.revokeObjectURL(url);
                
                if (audioDuration && !isNaN(audioDuration)) {
                    const minutes = Math.floor(audioDuration / 60);
                    const seconds = Math.floor(audioDuration % 60);
                    durationInfo.textContent = `Duration: ${minutes}:${seconds.toString().padStart(2, '0')} (${(audioDuration / 60).toFixed(1)} minutes)`;
                    
                    if (audioDuration > MAX_DURATION) {
                        durationError.style.display = 'block';
                        durationError.innerHTML = `Audio duration (${(audioDuration / 60).toFixed(1)} minutes) exceeds the 30-minute limit. ` +
                            `Please use the <a href="{% url 'media_converter:audio_splitter' %}" style="color: var(--primary-color); text-decoration: underline;">Audio Splitter tool</a> to shorten your file first.`;
                        isValidDuration = false;
                        submitBtn.disabled = true;
                    } else {
                        durationError.style.display = 'none';
                        isValidDuration = true;
                        submitBtn.disabled = false;
                    }
                } else {
                    // Duration couldn't be determined, allow upload (server will validate)
                    durationInfo.textContent = 'File selected. Duration will be validated on server.';
                    isValidDuration = true;
                    submitBtn.disabled = false;
                }
            });
            
            audio.addEventListener('error', function() {
                clearTimeout(durationTimeout);
                URL.revokeObjectURL(url);
                // Some audio formats (like M4A) may not be readable by HTML5 Audio API
                // Allow upload and let server validate
                if (allowedExts.includes(fileExt)) {
                    durationInfo.textContent = 'File selected. Duration will be validated on server.';
                    isValidDuration = true;
                    submitBtn.disabled = false;
                } else {
                    durationInfo.textContent = 'Could not read audio file. Please ensure it is a valid audio file.';
                    isValidDuration = false;
                    submitBtn.disabled = true;
                }
            });
            
            audio.src = url;
        } else {
            durationInfo.style.display = 'none';
            durationError.style.display = 'none';
            isValidDuration = false;
            submitBtn.disabled = false;
        }
    });
    
    // Form submission with async job polling
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Always prevent default for async handling
        
        if (!isValidDuration && audioDuration !== null) {
                alert('Please ensure your audio file is 30 minutes (1800 seconds) or less before submitting.');
            return false;
        }
        
        if (!fileInput.files.length) {
            alert('Please select an audio file.');
            return false;
        }
        
        // Hide previous results
        document.getElementById('resultsArea').style.display = 'none';
        document.getElementById('jobStatusArea').style.display = 'none';
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading...';
        
        // Create FormData
        const formData = new FormData(form);
        
        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Submit via AJAX
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // Not JSON - might be HTML error page
                return response.text().then(text => {
                    throw new Error('Server returned non-JSON response. Please check the console for details.');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                // Show error
                showJobError(data.error);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Transcribe Audio';
                return;
            }
            
            // Job created successfully
            const jobId = data.job_id;
            if (!jobId) {
                showJobError('No job ID received from server. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Transcribe Audio';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            // Show job status area
            showJobStatus(jobId, 'pending', 'Job created. Processing in background...');
            
            // Start polling
            pollJobStatus(jobId);
        })
        .catch(error => {
            console.error('Error:', error);
            showJobError('An error occurred while uploading the file: ' + error.message + '. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Transcribe Audio';
        });
    });
    
    // Poll job status
    let pollInterval = null;
    let pollAttempts = 0;
    const MAX_POLL_ATTEMPTS = 300; // 5 minutes max (300 * 1 second)
    
    function pollJobStatus(jobId) {
        pollAttempts = 0;
        pollInterval = setInterval(function() {
            pollAttempts++;
            
            if (pollAttempts > MAX_POLL_ATTEMPTS) {
                clearInterval(pollInterval);
                showJobError('Job is taking longer than expected. Please check back later or try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Transcribe Audio';
                return;
            }
            
            fetch(`/text-converter/audio-transcription/status/${jobId}/`)
                .then(response => response.json())
                .then(data => {
                    updateJobStatus(data);
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(pollInterval);
                        
                        if (data.status === 'completed') {
                            showResults(data);
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Transcribe Audio';
                        } else {
                            showJobError(data.error_message || 'Transcription failed. Please try again.');
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Transcribe Audio';
                        }
                    }
                })
                .catch(error => {
                    console.error('Polling error:', error);
                    // Continue polling on error (might be temporary)
                });
        }, 2000); // Poll every 2 seconds
    }
    
    // Show job status
    function showJobStatus(jobId, status, message) {
        const statusArea = document.getElementById('jobStatusArea');
        const statusContent = document.getElementById('jobStatusContent');
        
        let statusIcon = '‚è≥';
        let statusClass = 'alert-info';
        
        if (status === 'processing') {
            statusIcon = '‚öôÔ∏è';
            statusClass = 'alert-info';
        } else if (status === 'completed') {
            statusIcon = '‚úÖ';
            statusClass = 'alert-success';
        } else if (status === 'failed') {
            statusIcon = '‚ùå';
            statusClass = 'alert-error';
        }
        
        statusContent.innerHTML = `
            <div class="alert ${statusClass}" style="margin-bottom: 0;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 1.5rem;">${statusIcon}</span>
                    <div style="flex: 1;">
                        <strong>${message || 'Processing...'}</strong>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem; color: var(--text-secondary);">
                            Job ID: <code>${jobId}</code>
                        </div>
                        ${status === 'processing' ? '<div style="margin-top: 0.5rem;"><div class="spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid var(--primary-color); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div></div>' : ''}
                    </div>
                </div>
            </div>
        `;
        
        statusArea.style.display = 'block';
    }
    
    // Update job status
    function updateJobStatus(data) {
        let message = 'Processing...';
        if (data.status === 'processing') {
            message = 'Transcribing audio file...';
        } else if (data.status === 'completed') {
            message = 'Transcription completed!';
        } else if (data.status === 'failed') {
            message = 'Transcription failed';
        }
        
        showJobStatus(data.job_id, data.status, message);
    }
    
    // Show job error
    function showJobError(errorMessage) {
        const statusArea = document.getElementById('jobStatusArea');
        const statusContent = document.getElementById('jobStatusContent');
        
        statusContent.innerHTML = `
            <div class="alert alert-error" style="margin-bottom: 0;">
                <strong>‚ùå Error:</strong> ${errorMessage}
            </div>
        `;
        
        statusArea.style.display = 'block';
    }
    
    // Show results
    function showResults(data) {
        const resultsArea = document.getElementById('resultsArea');
        const transcriptionText = document.getElementById('transcriptionText');
        const languageInfo = document.getElementById('languageInfo');
        const downloadDocxBtn = document.getElementById('downloadDocxBtn');
        
        // Set transcription text
        transcriptionText.value = data.transcription_text || '';
        
        // Show language info if available
        if (data.detected_language) {
            languageInfo.innerHTML = `
                <strong style="color: var(--primary-color);">Detected Language:</strong>
                <span style="text-transform: uppercase;">${data.detected_language}</span>
            `;
            languageInfo.style.display = 'block';
        } else {
            languageInfo.style.display = 'none';
        }
        
        // Set download DOCX button
        if (downloadDocxBtn) {
            downloadDocxBtn.onclick = function() {
                window.location.href = `/text-converter/audio-transcription/download-docx/${data.job_id}/`;
            };
        }
        
        // Show results area
        resultsArea.style.display = 'block';
        
        // Scroll to results
        resultsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Add spinner animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
    
    // Drag and drop support
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary-color)';
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = '';
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = '';
        
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change'));
        }
    });
});

function copyTranscription() {
    const textarea = document.getElementById('transcriptionText') || document.querySelector('textarea[readonly]');
    if (textarea && textarea.value) {
        textarea.select();
        document.execCommand('copy');
        
        const btn = document.querySelector('button[onclick="copyTranscription()"]');
        if (btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(function() {
                btn.textContent = originalText;
            }, 2000);
        }
    }
}

function downloadTranscription() {
    const textarea = document.getElementById('transcriptionText') || document.querySelector('textarea[readonly]');
    if (textarea && textarea.value) {
        const text = textarea.value;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Generate filename with timestamp
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        a.download = `transcription-${timestamp}.txt`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show feedback
        const btn = document.querySelector('button[onclick="downloadTranscription()"]');
        if (btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Downloaded!';
            setTimeout(function() {
                btn.textContent = originalText;
            }, 2000);
        }
    }
}
</script>
{% endblock %}

