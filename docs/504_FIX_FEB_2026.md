# 504 Gateway Timeout Fix (February 2026)

## Root Cause

The site was returning **HTTP 504 Gateway Timeout** intermittently because:

1. **Docker entrypoint blocked for 30–90+ seconds** on every container restart
2. It ran `migrate` and `collectstatic` **before** starting Gunicorn
3. During that time, Nginx proxied to localhost:8000 but nothing was listening
4. After ~60 seconds, Nginx returned 504

Sitechecker and other monitors checking during this window saw 504.

## Changes Made

### 1. Entrypoint (`entrypoint.sh`)

- **Still runs:** `migrate` (fast, usually <10s)
- **Skips on restart:** `collectstatic` when `staticfiles` already has content
- **Runs on first deploy:** `collectstatic` when `staticfiles` is empty

So after `quick_deploy.sh` restarts the web container:

- `migrate` runs (~5–10s)
- `collectstatic` is skipped (already done by deploy script)
- Gunicorn starts almost immediately
- Site is back in ~5–10 seconds instead of 30–90+

### 2. Quick Deploy (`quick_deploy.sh`)

- Added `migrate --noinput` before CSS minify and collectstatic
- Ensures migrations run before restart and catches migration errors early

### 3. Nginx Health Check

- Health check location now has explicit timeouts (5s connect, 10s read/send)
- Helps fail fast when the app is not ready

## Deployment Steps

1. **Commit and push all changes**

2. **On the VPS:**

   ```bash
   cd /opt/flipunit
   git pull origin main
   ```

3. **Rebuild the web image** (because entrypoint changed):

   ```bash
   docker compose build web
   ```

4. **Reload Nginx** (if you updated `nginx_flipunit.eu.conf`):

   ```bash
   sudo nginx -t && sudo systemctl reload nginx
   ```

5. **Restart the web container** (or run `quick_deploy.sh` for full deploy):

   ```bash
   docker compose up -d web
   ```

6. **Verify:**

   ```bash
   curl -I https://flipunit.eu/
   curl https://flipunit.eu/health/
   ```

## Notes

- First deploy or fresh volume: entrypoint still runs `collectstatic` when `staticfiles` is empty.
- Subsequent restarts: `collectstatic` is skipped because `quick_deploy.sh` runs it before restart.
